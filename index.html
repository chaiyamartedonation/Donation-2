import React, { useState, useEffect, useMemo } from 'react';
import { 
  Home, PlusCircle, ClipboardList, CheckCircle, User, ShieldCheck, Filter, 
  Check, X, ArrowLeft, HeartHandshake, MapPin, Phone, Calendar, BookOpen, 
  Menu, ChevronRight, Download, Printer, Lock, LogOut, FileText, Megaphone, 
  Mic, RotateCcw, CalendarDays, Pencil, Save, Key, QrCode, ShoppingBag, 
  UploadCloud, Image as ImageIcon, Loader, Info, Settings, Trash2, AlertTriangle, Plus
} from 'lucide-react';
import { initializeApp } from "firebase/app";
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken,
  onAuthStateChanged
} from "firebase/auth";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  updateDoc, 
  doc, 
  onSnapshot, 
  query,
  setDoc,
  deleteDoc,
  getDocs,
  writeBatch
} from "firebase/firestore";

// ==========================================
// FIREBASE INIT & CONFIG
// ==========================================
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'temple-app';

// ==========================================
// DEFAULT SETTINGS (Fallback)
// ==========================================
const DEFAULT_SETTINGS = {
    systemStatus: 'open', // open, closed, maintenance
    templeName: 'วัดไชยามาตย์',
    bannerUrl: 'https://images.unsplash.com/photo-1590484501469-808ceea194f4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
    qrCodeUrl: 'https://img2.pic.in.th/pic/099400240646898.png',
    bankInfo: {
        bankName: 'ธ.กรุงไทย',
        accountName: 'วัดไชยามาตย์',
        accountNumber: 'xxx-x-xxxxx-x'
    },
    contact: {
        phone: '082-2801992',
        address: 'หมู่ที่ 1 ตำบลเวียงทอง อำเภอสูงเม่น จังหวัดแพร่ 54130'
    },
    donationTypes: [
        { id: 'general', name: 'บริจาคทั่วไป / ค่าน้ำค่าไฟ', hasQuantity: false, price: 0, active: true },
        { id: 'thai_taan', name: 'ไทยทาน', hasQuantity: true, price: 300, unit: 'ชุด', active: true },
        { id: 'hua_wat', name: 'หัววัด', hasQuantity: true, price: 500, unit: 'ชุด', active: true },
        { id: 'roong_taan', name: 'จองโรงทาน', isSpecial: true, active: true } // Special type handling
    ]
};

// ==========================================
// HELPER: Image Resizer
// ==========================================
const resizeImage = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 800;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                resolve(canvas.toDataURL('image/jpeg', 0.7));
            };
            img.onerror = reject;
        };
        reader.onerror = reject;
    });
};

// ==========================================
// COMPONENT: Notification Toast
// ==========================================
const NotificationToast = ({ msg, onClose, type = 'success' }) => {
    if (!msg) return null;
    const bgColor = type === 'success' ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800';
    
    return (
        <div className={`fixed top-4 right-4 z-[100] flex items-center p-4 mb-4 rounded-lg border-l-4 shadow-lg animate-bounce-in ${bgColor}`}>
            <div className="text-sm font-medium">{msg}</div>
            <button onClick={onClose} className="ml-4 hover:opacity-70">
                <X className="w-4 h-4" />
            </button>
        </div>
    );
};

// ==========================================
// MAIN APP COMPONENT
// ==========================================
export default function App() {
    const [currentRoute, setCurrentRoute] = useState('home');
    const [donations, setDonations] = useState([]);
    const [settings, setSettings] = useState(DEFAULT_SETTINGS);
    const [loading, setLoading] = useState(true);
    const [user, setUser] = useState(null);
    const [notification, setNotification] = useState(null);

    // Auth Initialization
    useEffect(() => {
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
            }
        };
        initAuth();
        const unsubscribe = onAuthStateChanged(auth, setUser);
        return () => unsubscribe();
    }, []);

    // Fetch Settings
    useEffect(() => {
        if (!user) return;
        const unsubscribe = onSnapshot(doc(db, 'artifacts', appId, 'public', 'settings'), (docSnap) => {
            if (docSnap.exists()) {
                setSettings({ ...DEFAULT_SETTINGS, ...docSnap.data() });
            } else {
                // Initialize settings if not exists
                setDoc(doc(db, 'artifacts', appId, 'public', 'settings'), DEFAULT_SETTINGS);
            }
        });
        return () => unsubscribe();
    }, [user]);

    // Fetch Donations
    useEffect(() => {
        if (!user) return;
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'donations'));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            docs.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
            setDonations(docs);
            setLoading(false);
        }, (error) => {
            console.error("Data fetch error:", error);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [user]);

    const showNotification = (msg, type = 'success') => {
        setNotification({ msg, type });
        setTimeout(() => setNotification(null), 3000);
    };

    const handleAddDonation = async (newDonation) => {
        if (!user) return;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'donations'), newDonation);
            showNotification('บันทึกข้อมูลสำเร็จ');
        } catch (e) {
            showNotification("เกิดข้อผิดพลาด: " + e.message, 'error');
        }
    };

    const handleUpdateDonation = async (updatedDonation) => {
        if (!user) return;
        try {
            const { id, ...data } = updatedDonation;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'donations', id), data);
            showNotification('อัปเดตข้อมูลสำเร็จ');
        } catch (e) {
            showNotification("แก้ไขไม่สำเร็จ: " + e.message, 'error');
        }
    };

    const handleUpdateSettings = async (newSettings) => {
        if (!user) return;
        try {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'settings'), newSettings);
            showNotification('บันทึกการตั้งค่าระบบเรียบร้อย');
        } catch (e) {
            showNotification("ตั้งค่าไม่สำเร็จ: " + e.message, 'error');
        }
    };

    const handleClearAllData = async () => {
        if (!user) return;
        try {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'donations'));
            const snapshot = await getDocs(q);
            const batch = writeBatch(db);
            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
            showNotification('ล้างข้อมูลการบริจาคทั้งหมดเรียบร้อยแล้ว');
        } catch (e) {
            showNotification("ล้างข้อมูลไม่สำเร็จ: " + e.message, 'error');
        }
    };

    return (
        <div className="font-sans text-gray-800">
            {notification && (
                <NotificationToast 
                    msg={notification.msg} 
                    type={notification.type} 
                    onClose={() => setNotification(null)} 
                />
            )}
            
            {loading ? (
                <div className="min-h-screen flex flex-col items-center justify-center bg-orange-50 text-orange-600">
                    <Loader className="w-10 h-10 animate-spin mb-4" />
                    <p>กำลังเชื่อมต่อฐานข้อมูล...</p>
                </div>
            ) : currentRoute === 'donate-system' ? (
                <DonationSystem 
                    onBack={() => setCurrentRoute('home')} 
                    donations={donations}
                    settings={settings}
                    onAdd={handleAddDonation}
                    onUpdate={handleUpdateDonation}
                    onUpdateSettings={handleUpdateSettings}
                    onClearData={handleClearAllData}
                    showNotification={showNotification}
                    user={user}
                />
            ) : (
                <OfficialWebsite 
                    onNavigate={(route) => setCurrentRoute(route)} 
                    donations={donations} 
                    settings={settings}
                />
            )}
        </div>
    );
}

// ==========================================
// COMPONENT: Official Website
// ==========================================
function OfficialWebsite({ onNavigate, donations, settings }) {
    const [isScrolled, setIsScrolled] = useState(false);
    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
    const totalAmount = useMemo(() => donations.filter(d => d.status === 'approved').reduce((sum, d) => sum + d.amount, 0), [donations]);

    useEffect(() => {
        const handleScroll = () => setIsScrolled(window.scrollY > 50);
        window.addEventListener('scroll', handleScroll);
        return () => window.removeEventListener('scroll', handleScroll);
    }, []);

    const navLinks = [
        { name: 'หน้าหลัก', href: '#home' }, 
        { name: 'ประวัติวัด', href: '#about' }, 
        { name: 'ติดต่อเรา', href: '#contact' }
    ];

    if (settings.systemStatus === 'maintenance') {
        return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 text-gray-600 p-4 text-center">
                <AlertTriangle className="w-16 h-16 text-yellow-500 mb-4" />
                <h1 className="text-3xl font-bold mb-2">ปิดปรับปรุงชั่วคราว</h1>
                <p>ระบบกำลังดำเนินการปรับปรุง ขออภัยในความไม่สะดวก</p>
                <p className="mt-4 text-sm text-gray-500">{settings.templeName}</p>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-orange-50 text-gray-800 scroll-smooth">
            <nav className={`fixed w-full z-50 transition-all duration-300 ${isScrolled ? 'bg-white shadow-md py-2' : 'bg-transparent py-4'}`}>
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${isScrolled ? 'bg-orange-600 text-white' : 'bg-white text-orange-600'}`}>
                                <BookOpen className="w-6 h-6" />
                            </div>
                            <span className={`text-xl font-bold ${isScrolled ? 'text-orange-800' : 'text-white drop-shadow-md'}`}>
                                {settings.templeName}
                            </span>
                        </div>
                        <div className="hidden md:flex items-center space-x-8">
                            {navLinks.map((link) => (
                                <a key={link.name} href={link.href} className={`font-medium hover:text-orange-400 transition-colors ${isScrolled ? 'text-gray-600' : 'text-white drop-shadow-md'}`}>{link.name}</a>
                            ))}
                            {settings.systemStatus === 'open' && (
                                <button onClick={() => onNavigate('donate-system')} className="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-full font-bold flex items-center transition-transform hover:scale-105 shadow-lg">
                                    <HeartHandshake className="w-5 h-5 mr-2" />
                                    ร่วมทำบุญ
                                </button>
                            )}
                        </div>
                        <div className="md:hidden">
                            <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className={isScrolled ? 'text-gray-800' : 'text-white'}>
                                {mobileMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                            </button>
                        </div>
                    </div>
                </div>
                {mobileMenuOpen && (
                    <div className="md:hidden bg-white absolute top-full left-0 w-full shadow-lg border-t border-gray-100">
                        <div className="px-4 pt-2 pb-4 space-y-1 flex flex-col">
                            {navLinks.map((link) => (
                                <a key={link.name} href={link.href} onClick={() => setMobileMenuOpen(false)} className="block px-3 py-3 text-base font-medium text-gray-700 hover:text-orange-600 hover:bg-orange-50 rounded-md">{link.name}</a>
                            ))}
                            {settings.systemStatus === 'open' && (
                                <button onClick={() => onNavigate('donate-system')} className="mt-4 w-full bg-orange-600 text-white px-4 py-3 rounded-md font-bold flex justify-center items-center">
                                    <HeartHandshake className="w-5 h-5 mr-2" />
                                    เข้าสู่ระบบร่วมทำบุญออนไลน์
                                </button>
                            )}
                        </div>
                    </div>
                )}
            </nav>

            <section id="home" className="relative h-[85vh] flex items-center justify-center bg-gray-900">
                <div className="absolute inset-0 w-full h-full">
                    <img src={settings.bannerUrl} alt="ภาพวัด" className="w-full h-full object-cover opacity-60" />
                    <div className="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
                </div>
                <div className="relative z-20 text-center px-4 max-w-4xl mx-auto">
                    <span className="block text-orange-400 font-semibold tracking-wider mb-2">ยินดีต้อนรับสู่</span>
                    <h1 className="text-5xl md:text-7xl font-bold text-white mb-6 leading-tight drop-shadow-lg">{settings.templeName}</h1>
                    <p className="text-xl md:text-2xl text-gray-200 mb-8 drop-shadow">ศูนย์รวมจิตใจชาวตำบลเวียงทอง สืบสานพระพุทธศาสนาและวัฒนธรรมล้านนา</p>
                    <div className="mb-10 inline-block">
                        <div className="backdrop-blur-md bg-white/10 border border-white/30 rounded-2xl p-6 shadow-2xl transform hover:scale-105 transition duration-300">
                            <p className="text-orange-200 text-sm md:text-base font-medium mb-1 uppercase tracking-widest">ยอดบริจาครวมทั้งหมด</p>
                            <div className="text-4xl md:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 via-yellow-400 to-yellow-200 drop-shadow-sm">฿ {totalAmount.toLocaleString()}</div>
                        </div>
                    </div>
                    {settings.systemStatus === 'open' ? (
                        <div className="flex flex-col sm:flex-row gap-4 justify-center">
                            <button onClick={() => onNavigate('donate-system')} className="bg-orange-600 hover:bg-orange-700 text-white px-8 py-4 rounded-full font-bold text-lg flex items-center justify-center transition-transform hover:scale-105 shadow-xl border-2 border-orange-500">
                                <HeartHandshake className="w-6 h-6 mr-2" />
                                ร่วมบริจาค / จองโรงทาน
                            </button>
                            <a href="#about" className="bg-white/20 hover:bg-white/30 backdrop-blur-md text-white px-8 py-4 rounded-full font-bold text-lg flex items-center justify-center transition-colors border border-white/50">ประวัติความเป็นมา</a>
                        </div>
                    ) : (
                        <div className="bg-red-500/80 backdrop-blur text-white px-6 py-3 rounded-lg inline-block">
                            ขณะนี้ปิดรับบริจาคชั่วคราว
                        </div>
                    )}
                </div>
            </section>

            <section id="about" className="py-20 bg-white">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex flex-col md:flex-row items-center gap-12">
                        <div className="md:w-1/2 relative">
                            <div className="absolute -inset-4 bg-orange-100 rounded-3xl transform rotate-3 -z-10"></div>
                            <img src="https://images.unsplash.com/photo-1579548231964-b0a701fccf23?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="ประวัติวัด" className="w-full h-auto rounded-2xl shadow-lg object-cover aspect-[4/3]" />
                        </div>
                        <div className="md:w-1/2">
                            <div className="flex items-center gap-2 text-orange-600 font-semibold mb-2"><BookOpen className="w-5 h-5" /> ประวัติและข้อมูล</div>
                            <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mb-6">ความร่มเย็นแห่ง<span className="text-orange-600">ล้านนา</span></h2>
                            <p className="text-gray-600 text-lg leading-relaxed mb-6">{settings.templeName} ตั้งอยู่ที่ตำบลเวียงทอง อำเภอสูงเม่น จังหวัดแพร่ เป็นวัดที่มีความสำคัญและเป็นศูนย์รวมจิตใจของชุมชนมาอย่างยาวนาน โดดเด่นด้วยสถาปัตยกรรมที่งดงามตามแบบฉบับศิลปะล้านนา</p>
                        </div>
                    </div>
                </div>
            </section>

            <footer id="contact" className="bg-gray-900 text-white pt-16 pb-8">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-12 mb-12 border-b border-gray-800 pb-12">
                        <div>
                            <div className="flex items-center gap-3 mb-6"><div className="w-10 h-10 rounded-full bg-orange-600 flex items-center justify-center text-white"><BookOpen className="w-6 h-6" /></div><span className="text-2xl font-bold text-white">{settings.templeName}</span></div>
                        </div>
                        <div>
                            <h3 className="text-lg font-bold mb-6 text-white">ข้อมูลติดต่อ</h3>
                            <ul className="space-y-4">
                                <li className="flex items-start"><MapPin className="w-5 h-5 text-orange-500 mr-3 mt-1 flex-shrink-0" /><span className="text-gray-400">{settings.contact.address}</span></li>
                                <li className="flex items-center"><Phone className="w-5 h-5 text-orange-500 mr-3 flex-shrink-0" /><span className="text-gray-400">{settings.contact.phone}</span></li>
                            </ul>
                        </div>
                        <div><h3 className="text-lg font-bold mb-6 text-white">เวลาทำการ</h3><p className="text-gray-400">06:00 - 18:00 น. ทุกวัน</p></div>
                    </div>
                    <div className="text-center text-gray-500 text-sm"><p>&copy; {new Date().getFullYear()} {settings.templeName}. All rights reserved.</p></div>
                </div>
            </footer>
        </div>
    );
}

// ==========================================
// COMPONENT: Donation System
// ==========================================
function DonationSystem({ onBack, donations, settings, onAdd, onUpdate, onUpdateSettings, onClearData, showNotification, user }) {
    const [activeTab, setActiveTab] = useState('donate');
    const [userRole, setUserRole] = useState('donor'); 
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [showLoginModal, setShowLoginModal] = useState(false);
    const [pendingRole, setPendingRole] = useState(null); 

    const handleRoleSwitch = (newRole) => {
        if (newRole === 'donor') { 
            setUserRole('donor'); 
            setIsAuthenticated(false); 
            setActiveTab('donate'); 
        } else { 
            setPendingRole(newRole); 
            setShowLoginModal(true); 
        }
    };

    const handleLogout = () => { 
        setUserRole('donor'); 
        setIsAuthenticated(false); 
        setActiveTab('donate'); 
        showNotification('ออกจากระบบเรียบร้อยแล้ว'); 
    };
    
    const toggleAnnounced = (id, status) => { 
        const item = donations.find(d => d.id === id); 
        if (item) onUpdate({ ...item, announced: status }); 
    };

    return (
        <div className="min-h-screen bg-orange-50 text-gray-800 no-print">
            {showLoginModal && (
                <LoginModal 
                    role={pendingRole}
                    onClose={() => setShowLoginModal(false)}
                    onLoginSuccess={() => { 
                        setUserRole(pendingRole); 
                        setIsAuthenticated(true); 
                        setShowLoginModal(false); 
                        showNotification(`เข้าสู่ระบบในฐานะ ${pendingRole === 'staff' ? 'เจ้าหน้าที่' : 'ผู้ดูแลระบบ'} สำเร็จ`); 
                    }}
                />
            )}

            <header className="bg-orange-600 text-white shadow-md no-print">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <div className="flex items-center gap-4 w-full sm:w-auto">
                        <button onClick={onBack} className="p-2 bg-orange-700 hover:bg-orange-800 rounded-full transition-colors shrink-0" title="กลับหน้าเว็บไซต์หลัก">
                            <ArrowLeft className="w-6 h-6" />
                        </button>
                        <div>
                            <h1 className="text-xl sm:text-2xl font-bold">ระบบรับบริจาค{settings.templeName}</h1>
                            <p className="text-xs sm:text-sm text-orange-200">ระบบจัดการออนไลน์</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-end">
                        {isAuthenticated ? (
                            <div className="flex items-center gap-3 bg-orange-700 px-4 py-2 rounded-lg">
                                <div className="flex items-center gap-2">
                                    <User className="w-5 h-5 text-orange-200" />
                                    <span className="font-medium text-sm">{userRole === 'staff' ? 'เจ้าหน้าที่ (Staff)' : 'ผู้ดูแลระบบ (Admin)'}</span>
                                </div>
                                <button onClick={handleLogout} className="bg-red-500 hover:bg-red-600 text-white p-1 rounded transition-colors" title="ออกจากระบบ">
                                    <LogOut className="w-4 h-4" />
                                </button>
                            </div>
                        ) : (
                            <div className="flex items-center gap-2 text-sm bg-orange-700 p-2 rounded-lg">
                                <span className="font-medium whitespace-nowrap flex items-center gap-1"><Lock className="w-3 h-3"/> เข้าใช้งาน:</span>
                                <select className="bg-white text-gray-800 rounded px-2 py-1 outline-none w-full sm:w-auto text-xs sm:text-sm cursor-pointer" value={userRole} onChange={(e) => handleRoleSwitch(e.target.value)}>
                                    <option value="donor">ผู้บริจาค (Guest)</option>
                                    <option value="staff">หน่วยรับบริจาค (Staff)</option>
                                    <option value="admin">ผู้ดูแลระบบ (Admin)</option>
                                </select>
                            </div>
                        )}
                    </div>
                </div>
            </header>

            <nav className="bg-white shadow-sm sticky top-0 z-10 no-print">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div className="flex space-x-4 overflow-x-auto hide-scrollbar">
                        <button onClick={() => setActiveTab('donate')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'donate' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                            <PlusCircle className="w-5 h-5 mr-2 shrink-0" /> {userRole === 'donor' ? 'บริจาคออนไลน์' : 'บันทึกรับบริจาค'}
                        </button>
                        {isAuthenticated && (
                            <button onClick={() => setActiveTab('dashboard')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'dashboard' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                <ClipboardList className="w-5 h-5 mr-2 shrink-0" /> สรุป/รายงาน
                            </button>
                        )}
                        {isAuthenticated && (
                            <button onClick={() => setActiveTab('announcer')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'announcer' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                <Megaphone className="w-5 h-5 mr-2 shrink-0" /> โฆษก/ประกาศ
                            </button>
                        )}
                        {isAuthenticated && userRole === 'admin' && (
                            <>
                                <button onClick={() => setActiveTab('approval')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'approval' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                    <CheckCircle className="w-5 h-5 mr-2 shrink-0" /> อนุมัติรายการ 
                                    {donations.filter(d => d.status === 'pending').length > 0 && <span className="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full shrink-0">{donations.filter(d => d.status === 'pending').length}</span>}
                                </button>
                                <button onClick={() => setActiveTab('settings')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'settings' ? 'border-orange-500 text-orange-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                    <Settings className="w-5 h-5 mr-2 shrink-0" /> ตั้งค่าระบบ
                                </button>
                            </>
                        )}
                    </div>
                </div>
            </nav>

            <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-20 print-container">
                {activeTab === 'donate' && (
                    <DonationForm 
                        userRole={userRole} 
                        settings={settings}
                        onSave={(newDonation) => { 
                            onAdd(newDonation); 
                        }} 
                        showNotification={showNotification}
                    />
                )}
                {activeTab === 'dashboard' && isAuthenticated && (
                    <Dashboard 
                        donations={donations} 
                        userRole={userRole} 
                        onUpdateDonation={(d) => { onUpdate(d); }} 
                        showNotification={showNotification}
                    />
                )}
                {activeTab === 'announcer' && isAuthenticated && (
                    <AnnouncerPanel donations={donations} onUpdateStatus={toggleAnnounced} />
                )}
                {activeTab === 'approval' && userRole === 'admin' && isAuthenticated && (
                    <ApprovalPanel 
                        donations={donations} 
                        onApprove={(id) => { 
                            const item = donations.find(d => d.id === id); 
                            if (item) onUpdate({ ...item, status: 'approved' }); 
                        }} 
                        onReject={(id) => { 
                            const item = donations.find(d => d.id === id); 
                            if (item) onUpdate({ ...item, status: 'rejected' }); 
                        }} 
                    />
                )}
                {activeTab === 'settings' && userRole === 'admin' && isAuthenticated && (
                    <AdminSettingsPanel 
                        settings={settings}
                        onSave={onUpdateSettings}
                        onClearData={onClearData}
                    />
                )}
            </main>
        </div>
    );
}

// ==========================================
// COMPONENT: Admin Settings Panel
// ==========================================
function AdminSettingsPanel({ settings, onSave, onClearData }) {
    const [config, setConfig] = useState(settings);
    const [confirmClear, setConfirmClear] = useState('');
    const [showClearModal, setShowClearModal] = useState(false);

    // Sync state when settings prop updates
    useEffect(() => {
        setConfig(settings);
    }, [settings]);

    const handleSave = () => {
        onSave(config);
    };

    const handleAddDonationType = () => {
        const newType = { 
            id: `type_${Date.now()}`, 
            name: 'รายการใหม่', 
            hasQuantity: false, 
            price: 0, 
            active: true 
        };
        setConfig({
            ...config,
            donationTypes: [...(config.donationTypes || []), newType]
        });
    };

    const handleRemoveDonationType = (index) => {
        const newTypes = [...config.donationTypes];
        newTypes.splice(index, 1);
        setConfig({...config, donationTypes: newTypes});
    };

    const handleUpdateDonationType = (index, field, value) => {
        const newTypes = [...config.donationTypes];
        newTypes[index] = { ...newTypes[index], [field]: value };
        setConfig({...config, donationTypes: newTypes});
    };

    const handleClearDataSubmit = () => {
        if (confirmClear === 'admin104') {
            onClearData();
            setShowClearModal(false);
            setConfirmClear('');
        } else {
            alert('รหัสผ่านไม่ถูกต้อง');
        }
    };

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold flex items-center text-gray-800">
                <Settings className="w-8 h-8 mr-2 text-orange-600" /> ตั้งค่าระบบ (Admin Config)
            </h2>
            
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* 1. System Status */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 className="text-lg font-bold mb-4 flex items-center"><PowerIcon className="w-5 h-5 mr-2" /> สถานะระบบ</h3>
                    <div className="flex gap-4">
                        <label className={`flex-1 p-3 rounded-lg border cursor-pointer text-center ${config.systemStatus === 'open' ? 'bg-green-50 border-green-500 text-green-700' : 'bg-gray-50'}`}>
                            <input type="radio" className="hidden" name="status" checked={config.systemStatus === 'open'} onChange={() => setConfig({...config, systemStatus: 'open'})} />
                            <span className="font-bold block">เปิดรับบริจาค</span>
                            <span className="text-xs">ใช้งานปกติ</span>
                        </label>
                        <label className={`flex-1 p-3 rounded-lg border cursor-pointer text-center ${config.systemStatus === 'closed' ? 'bg-red-50 border-red-500 text-red-700' : 'bg-gray-50'}`}>
                            <input type="radio" className="hidden" name="status" checked={config.systemStatus === 'closed'} onChange={() => setConfig({...config, systemStatus: 'closed'})} />
                            <span className="font-bold block">ปิดรับบริจาค</span>
                            <span className="text-xs">แสดงข้อความปิด</span>
                        </label>
                        <label className={`flex-1 p-3 rounded-lg border cursor-pointer text-center ${config.systemStatus === 'maintenance' ? 'bg-yellow-50 border-yellow-500 text-yellow-700' : 'bg-gray-50'}`}>
                            <input type="radio" className="hidden" name="status" checked={config.systemStatus === 'maintenance'} onChange={() => setConfig({...config, systemStatus: 'maintenance'})} />
                            <span className="font-bold block">ปิดปรับปรุง</span>
                            <span className="text-xs">ซ่อนหน้าเว็บ</span>
                        </label>
                    </div>
                </div>

                {/* 2. Temple Info & Images */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 className="text-lg font-bold mb-4 flex items-center"><ImageIcon className="w-5 h-5 mr-2" /> ข้อมูลและรูปภาพ</h3>
                    <div className="space-y-3">
                        <div>
                            <label className="block text-sm font-medium mb-1">ชื่อวัด / องค์กร</label>
                            <input type="text" className="w-full p-2 border rounded" value={config.templeName} onChange={e => setConfig({...config, templeName: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">ลิงค์รูปหน้าปก (Banner URL)</label>
                            <input type="text" className="w-full p-2 border rounded" value={config.bannerUrl} onChange={e => setConfig({...config, bannerUrl: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-1">ลิงค์รูป QR Code</label>
                            <input type="text" className="w-full p-2 border rounded" value={config.qrCodeUrl} onChange={e => setConfig({...config, qrCodeUrl: e.target.value})} />
                        </div>
                    </div>
                </div>

                {/* 3. Bank & Contact */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                    <h3 className="text-lg font-bold mb-4 flex items-center"><User className="w-5 h-5 mr-2" /> ธนาคารและการติดต่อ</h3>
                    <div className="space-y-3">
                        <div className="grid grid-cols-2 gap-2">
                            <div><label className="text-xs text-gray-500">ธนาคาร</label><input type="text" className="w-full p-2 border rounded" value={config.bankInfo?.bankName} onChange={e => setConfig({...config, bankInfo: {...config.bankInfo, bankName: e.target.value}})} /></div>
                            <div><label className="text-xs text-gray-500">ชื่อบัญชี</label><input type="text" className="w-full p-2 border rounded" value={config.bankInfo?.accountName} onChange={e => setConfig({...config, bankInfo: {...config.bankInfo, accountName: e.target.value}})} /></div>
                        </div>
                        <div><label className="text-xs text-gray-500">เลขบัญชี</label><input type="text" className="w-full p-2 border rounded font-mono" value={config.bankInfo?.accountNumber} onChange={e => setConfig({...config, bankInfo: {...config.bankInfo, accountNumber: e.target.value}})} /></div>
                        <div className="border-t pt-2 mt-2">
                            <label className="text-xs text-gray-500">เบอร์โทรติดต่อ</label>
                            <input type="text" className="w-full p-2 border rounded" value={config.contact?.phone} onChange={e => setConfig({...config, contact: {...config.contact, phone: e.target.value}})} />
                        </div>
                    </div>
                </div>

                {/* 4. Donation Types Configuration */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 lg:col-span-2">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-bold flex items-center"><ClipboardList className="w-5 h-5 mr-2" /> รายการรับบริจาค</h3>
                        <button onClick={handleAddDonationType} className="text-sm bg-blue-50 text-blue-600 px-3 py-1 rounded hover:bg-blue-100 flex items-center"><Plus className="w-4 h-4 mr-1"/> เพิ่มรายการ</button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-gray-500">
                                <tr>
                                    <th className="p-2">ชื่อรายการ</th>
                                    <th className="p-2 text-center">มีจำนวน?</th>
                                    <th className="p-2 text-right">ราคา/หน่วย</th>
                                    <th className="p-2 text-center">หน่วยนับ</th>
                                    <th className="p-2 text-center">ลบ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {config.donationTypes?.map((type, idx) => (
                                    <tr key={idx}>
                                        <td className="p-2">
                                            <input type="text" className="w-full p-1 border rounded" value={type.name} onChange={e => handleUpdateDonationType(idx, 'name', e.target.value)} disabled={type.isSpecial} />
                                        </td>
                                        <td className="p-2 text-center">
                                            <input type="checkbox" checked={type.hasQuantity} onChange={e => handleUpdateDonationType(idx, 'hasQuantity', e.target.checked)} disabled={type.isSpecial} />
                                        </td>
                                        <td className="p-2">
                                            <input type="number" className="w-full p-1 border rounded text-right" value={type.price || 0} onChange={e => handleUpdateDonationType(idx, 'price', parseInt(e.target.value))} disabled={!type.hasQuantity && !type.isSpecial} />
                                        </td>
                                        <td className="p-2">
                                            <input type="text" className="w-full p-1 border rounded text-center" value={type.unit || ''} onChange={e => handleUpdateDonationType(idx, 'unit', e.target.value)} disabled={!type.hasQuantity} placeholder="-" />
                                        </td>
                                        <td className="p-2 text-center">
                                            {!type.isSpecial && (
                                                <button onClick={() => handleRemoveDonationType(idx)} className="text-red-500 hover:text-red-700"><Trash2 className="w-4 h-4" /></button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div className="flex flex-col sm:flex-row gap-4 pt-4 border-t">
                <button onClick={handleSave} className="flex-1 bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-lg font-bold shadow-lg flex justify-center items-center">
                    <Save className="w-5 h-5 mr-2" /> บันทึกการตั้งค่า
                </button>
                <button onClick={() => setShowClearModal(true)} className="flex-none bg-red-100 hover:bg-red-200 text-red-700 py-3 px-6 rounded-lg font-bold flex justify-center items-center">
                    <Trash2 className="w-5 h-5 mr-2" /> ล้างข้อมูลบริจาค
                </button>
            </div>

            {/* Clear Data Modal */}
            {showClearModal && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 text-center animate-scale-up">
                        <AlertTriangle className="w-12 h-12 text-red-500 mx-auto mb-4" />
                        <h3 className="text-xl font-bold text-red-600 mb-2">ยืนยันล้างข้อมูลทั้งหมด?</h3>
                        <p className="text-gray-600 mb-4 text-sm">การกระทำนี้จะลบรายการบริจาคทั้งหมดอย่างถาวร ไม่สามารถกู้คืนได้</p>
                        <input type="password" placeholder="ใส่รหัส Admin เพื่อยืนยัน" className="w-full p-2 border border-red-300 rounded mb-4" value={confirmClear} onChange={e => setConfirmClear(e.target.value)} />
                        <div className="flex gap-2">
                            <button onClick={() => setShowClearModal(false)} className="flex-1 bg-gray-200 py-2 rounded">ยกเลิก</button>
                            <button onClick={handleClearDataSubmit} className="flex-1 bg-red-600 text-white py-2 rounded font-bold">ยืนยันลบ</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// Icon wrapper for power button since it might be missing in older lucide sets
const PowerIcon = (props) => (
    <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
);

// ==========================================
// COMPONENT: Login Modal
// ==========================================
function LoginModal({ role, onClose, onLoginSuccess }) {
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    
    const handleSubmit = (e) => { 
        e.preventDefault(); 
        if (role === 'staff' && password === '104') {
            onLoginSuccess();
        } else if (role === 'admin' && password === 'admin104') {
            onLoginSuccess();
        } else {
            setError('รหัสผ่านไม่ถูกต้อง (Hint: 104 หรือ admin104)');
        }
    };

    return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-sm w-full p-6 animate-scale-up">
                <div className="flex justify-between items-center mb-4">
                    <h3 className="text-xl font-bold text-gray-900 flex items-center">
                        <Lock className="w-5 h-5 mr-2 text-orange-600" /> เข้าสู่ระบบ ({role})
                    </h3>
                    <button onClick={onClose}><X className="w-5 h-5 text-gray-400" /></button>
                </div>
                <form onSubmit={handleSubmit}>
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-1">รหัสผ่าน</label>
                        <input type="password" className="w-full p-2 border border-gray-300 rounded outline-none focus:border-orange-500" value={password} onChange={(e) => setPassword(e.target.value)} autoFocus />
                        {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                    </div>
                    <button type="submit" className="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded transition-colors">ยืนยัน</button>
                </form>
            </div>
        </div>
    );
}

// ==========================================
// COMPONENT: Donation Form (Dynamic)
// ==========================================
function DonationForm({ userRole, onSave, showNotification, settings }) {
    const [name, setName] = useState('');
    const [method, setMethod] = useState('เงินโอน');
    const [generalNote, setGeneralNote] = useState('');
    const [slipImage, setSlipImage] = useState(null); 
    const [isUploading, setIsUploading] = useState(false);
    
    // Dynamic State for Donation Items
    const [selectedItems, setSelectedItems] = useState({});

    // Initialize item states based on settings
    useEffect(() => {
        const initial = {};
        settings.donationTypes.forEach(type => {
            if (type.active) {
                initial[type.id] = { checked: false, quantity: 1, amount: type.price || '' };
            }
        });
        // Check for special types like roong_taan
        const roongTaan = settings.donationTypes.find(t => t.id === 'roong_taan');
        if (roongTaan && roongTaan.active) {
            initial['roong_taan'] = { checked: false, date: '', note: '' };
        }
        
        // Merge with existing logic but ensure reset works
        setSelectedItems(prev => ({...initial, ...prev}));
    }, [settings.donationTypes]);

    const totalAmount = useMemo(() => {
        let sum = 0;
        settings.donationTypes.forEach(type => {
            if (selectedItems[type.id]?.checked && !type.isSpecial) {
                if (type.hasQuantity) {
                    sum += (selectedItems[type.id].quantity || 1) * type.price;
                } else {
                    sum += Number(selectedItems[type.id].amount || 0);
                }
            }
        });
        return sum;
    }, [selectedItems, settings.donationTypes]);

    const handleFileChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            setIsUploading(true);
            try { 
                const resized = await resizeImage(file); 
                setSlipImage(resized); 
            } catch (err) { 
                showNotification("ไม่สามารถอ่านไฟล์ภาพได้", 'error'); 
            }
            setIsUploading(false);
        }
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        if (settings.systemStatus === 'closed') {
            return showNotification('ขณะนี้ปิดรับบริจาคชั่วคราว', 'error');
        }

        if (!name) return showNotification('กรุณาระบุชื่อ-สกุล', 'error');
        
        const isRoongTaanChecked = selectedItems['roong_taan']?.checked;
        if (totalAmount <= 0 && !isRoongTaanChecked) return showNotification('กรุณาระบุยอดเงินบริจาค', 'error');
        
        if (isRoongTaanChecked && (!selectedItems['roong_taan'].date || !selectedItems['roong_taan'].note)) 
            return showNotification('กรุณาระบุวันที่และสิ่งของสำหรับโรงทาน', 'error');
        
        if (method === 'เงินโอน' && !slipImage && userRole === 'donor') 
            return showNotification('กรุณาแนบสลิปการโอนเงิน', 'error');

        let purposeParts = [];
        settings.donationTypes.forEach(type => {
            const item = selectedItems[type.id];
            if (item?.checked) {
                if (type.isSpecial && type.id === 'roong_taan') {
                    purposeParts.push(`จองโรงทาน`);
                } else if (type.hasQuantity) {
                    purposeParts.push(`${type.name} ${item.quantity} ${type.unit} (${(item.quantity * type.price).toLocaleString()} บาท)`);
                } else {
                    purposeParts.push(`${type.name} ${Number(item.amount).toLocaleString()} บาท`);
                }
            }
        });

        const newDonation = { 
            dateTime: new Date().toISOString(), 
            name, 
            purpose: purposeParts.join(', '), 
            amount: totalAmount, 
            method, 
            generalNote, 
            status: userRole === 'donor' ? 'pending' : 'approved', 
            source: userRole === 'donor' ? 'self' : 'staff', 
            announced: false,
            roongTaanDate: isRoongTaanChecked ? selectedItems['roong_taan'].date : null,
            roongTaanNote: isRoongTaanChecked ? selectedItems['roong_taan'].note : null,
            slipImage: slipImage 
        };
        onSave(newDonation);
        
        // Reset Form
        setName(''); setMethod('เงินโอน'); setGeneralNote(''); setSlipImage(null);
        // Reset selected items to unchecked
        const resetItems = {};
        Object.keys(selectedItems).forEach(key => {
            resetItems[key] = { ...selectedItems[key], checked: false, amount: '', quantity: 1, date: '', note: '' };
        });
        setSelectedItems(resetItems);
    };

    if (settings.systemStatus === 'closed' && userRole === 'donor') {
        return (
            <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-8 text-center text-red-600">
                <AlertTriangle className="w-16 h-16 mx-auto mb-4" />
                <h2 className="text-2xl font-bold">ขณะนี้ปิดรับบริจาคชั่วคราว</h2>
                <p className="text-gray-600 mt-2">โปรดติดต่อเจ้าหน้าที่ หรือกลับมาใหม่ภายหลัง</p>
            </div>
        );
    }

    return (
        <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden no-print">
            <div className="bg-orange-100 px-6 py-4 border-b border-orange-200 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
                <h2 className="text-xl font-semibold text-orange-800 flex items-center">
                    <PlusCircle className="w-6 h-6 mr-2 shrink-0" /> {userRole === 'donor' ? 'ฟอร์มแจ้งความประสงค์บริจาค' : 'บันทึกรับเงินบริจาค'}
                </h2>
                <span className="text-xs sm:text-sm text-gray-500 bg-white px-3 py-1 rounded-full border">
                    {userRole === 'donor' ? 'รอการตรวจสอบหลังบันทึก' : 'อนุมัติอัตโนมัติ'}
                </span>
            </div>
            
            <form onSubmit={handleSubmit} className="p-6 space-y-6">
                <div className="grid grid-cols-2 gap-4 text-sm text-gray-500 bg-gray-50 p-3 rounded-lg border">
                    <div><span className="font-semibold">ID:</span> อัตโนมัติ</div>
                    <div><span className="font-semibold">วันเวลา:</span> {new Date().toLocaleString('th-TH')}</div>
                </div>
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">ชื่อ - สกุล ผู้บริจาค <span className="text-red-500">*</span></label>
                    <input type="text" required className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-orange-500 outline-none" value={name} onChange={e => setName(e.target.value)} placeholder="เช่น นายบุญเรือง จิตใส" />
                </div>
                
                <div className="space-y-3">
                    <label className="block text-sm font-medium text-gray-700">เลือกประเภทการบริจาค (เลือกได้หลายรายการ)</label>
                    
                    {settings.donationTypes.filter(t => t.active).map(type => {
                        const itemState = selectedItems[type.id] || { checked: false, quantity: 1, amount: '' };
                        const isChecked = itemState.checked;

                        // Special Case: Roong Taan
                        if (type.isSpecial && type.id === 'roong_taan') {
                            return (
                                <div key={type.id} className={`p-3 rounded-lg border transition-colors ${isChecked ? 'bg-orange-50 border-orange-300' : 'border-gray-200 hover:bg-gray-50'}`}>
                                    <div className="flex items-center mb-2">
                                        <input type="checkbox" className="w-5 h-5 text-orange-600 rounded border-gray-300 focus:ring-orange-500" checked={isChecked} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, checked: e.target.checked}})} />
                                        <span className="ml-2 font-medium">{type.name}</span>
                                    </div>
                                    {isChecked && (
                                        <div className="ml-7 space-y-2">
                                            <input type="date" className="w-full p-2 border border-gray-300 rounded outline-none text-sm" value={itemState.date || ''} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, date: e.target.value}})} required />
                                            <input type="text" placeholder="ระบุสิ่งของ (เช่น ข้าวมันไก่)" className="w-full p-2 border border-gray-300 rounded outline-none text-sm" value={itemState.note || ''} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, note: e.target.value}})} required />
                                        </div>
                                    )}
                                </div>
                            );
                        }

                        // Regular Types
                        return (
                            <div key={type.id} className={`p-3 rounded-lg border transition-colors ${isChecked ? 'bg-orange-50 border-orange-300' : 'border-gray-200 hover:bg-gray-50'}`}>
                                <div className="flex items-center mb-2 justify-between">
                                    <div className="flex items-center">
                                        <input type="checkbox" className="w-5 h-5 text-orange-600 rounded border-gray-300 focus:ring-orange-500" checked={isChecked} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, checked: e.target.checked}})} />
                                        <span className="ml-2 font-medium">
                                            {type.name} {type.hasQuantity && `(${type.price}.-)`}
                                        </span>
                                    </div>
                                    {isChecked && type.hasQuantity && <span className="text-orange-600 font-bold">{itemState.quantity * type.price} บ.</span>}
                                </div>
                                {isChecked && (
                                    <div className="ml-7 flex items-center gap-2">
                                        {type.hasQuantity ? (
                                            <>
                                                <button type="button" className="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" onClick={() => setSelectedItems(prev => ({...prev, [type.id]: {...itemState, quantity: Math.max(1, (itemState.quantity || 1) - 1)}}))}>-</button>
                                                <input type="number" min="1" className="w-16 text-center border-none bg-transparent font-bold" value={itemState.quantity || 1} readOnly />
                                                <button type="button" className="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" onClick={() => setSelectedItems(prev => ({...prev, [type.id]: {...itemState, quantity: (itemState.quantity || 1) + 1}}))}>+</button>
                                                <span className="text-gray-500">{type.unit}</span>
                                            </>
                                        ) : (
                                            <>
                                                <input type="number" min="1" placeholder="ระบุจำนวนเงิน" className="w-full p-2 border border-gray-300 rounded outline-none" value={itemState.amount} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, amount: e.target.value}})} />
                                                <span className="text-gray-500">บาท</span>
                                            </>
                                        )}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>

                <div className="bg-orange-50 p-4 rounded-xl flex justify-between items-center border border-orange-100">
                    <span className="text-gray-700 font-semibold">ยอดรวมทั้งสิ้น</span>
                    <span className="text-2xl font-bold text-orange-600">{totalAmount.toLocaleString()} บาท</span>
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">ช่องทางการบริจาค</label>
                    <select className="w-full p-2 border border-gray-300 rounded outline-none bg-white" value={method} onChange={e => setMethod(e.target.value)}>
                        <option value="เงินโอน">โอนเงินเข้าบัญชีวัด</option>
                        <option value="เงินสด">เงินสด (นำมาให้ที่วัด)</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>

                <div className="bg-gray-50 rounded-lg border border-gray-200 p-4">
                    {(userRole === 'staff' || userRole === 'admin') ? (
                        <div className="flex items-center justify-center text-green-600 gap-2 py-2">
                            <CheckCircle className="w-5 h-5" />
                            <span className="font-medium">เจ้าหน้าที่บันทึก: ยืนยันการรับเงินแล้ว</span>
                        </div>
                    ) : method === 'เงินโอน' ? (
                        <div className="space-y-4 text-center">
                            <div className="animate-fade-in">
                                <p className="text-sm font-bold text-gray-700 mb-2">1. สแกน QR Code เพื่อโอนเงิน</p>
                                <div className="bg-white p-3 rounded-lg shadow-sm border inline-block">
                                    <img src={settings.qrCodeUrl} alt="QR Code" className="w-40 h-40 object-contain" />
                                </div>
                                <p className="text-xs text-gray-500 mt-1">{settings.bankInfo?.bankName} | {settings.bankInfo?.accountName}</p>
                                <p className="text-lg font-mono font-bold text-orange-700 mt-1 select-all">{settings.bankInfo?.accountNumber}</p>
                            </div>
                            <div className="border-t border-gray-200 pt-4">
                                <p className="text-sm font-bold text-gray-700 mb-2">2. แนบหลักฐานการโอน</p>
                                <label className="cursor-pointer block border-2 border-dashed border-gray-300 rounded-lg p-4 hover:bg-gray-100 transition">
                                    <div className="flex flex-col items-center justify-center">
                                        {isUploading ? <Loader className="w-6 h-6 animate-spin text-gray-400" /> : <UploadCloud className="w-6 h-6 text-gray-400 mb-1" />}
                                        <span className="text-sm text-gray-600">{slipImage ? 'เปลี่ยนรูปสลิป' : 'คลิกเพื่อเลือกรูปสลิป'}</span>
                                    </div>
                                    <input type="file" accept="image/*" className="hidden" onChange={handleFileChange} />
                                </label>
                                {slipImage && (
                                    <div className="mt-3 relative inline-block">
                                        <img src={slipImage} alt="Preview" className="h-24 object-contain rounded border bg-white" />
                                        <button type="button" onClick={() => setSlipImage(null)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow hover:bg-red-600">
                                            <X className="w-3 h-3" />
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center justify-center text-gray-500 py-4">
                            <ShoppingBag className="w-12 h-12 mb-2 opacity-30" />
                            <p className="text-sm">กรุณานำเงินสดมาบริจาคที่จุดรับบริจาค</p>
                        </div>
                    )}
                </div>

                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">หมายเหตุเพิ่มเติม</label>
                    <textarea rows="2" className="w-full p-2 border border-gray-300 rounded outline-none" value={generalNote} onChange={e => setGeneralNote(e.target.value)} placeholder="ข้อความเพิ่มเติม..."></textarea>
                </div>
                
                <button type="submit" disabled={isUploading} className={`w-full text-white font-bold py-3 px-4 rounded hover:bg-orange-700 transition shadow-lg flex justify-center items-center text-lg ${isUploading ? 'bg-gray-400' : 'bg-orange-600'}`}>
                    {isUploading ? 'กำลังประมวลผลรูป...' : <><CheckCircle className="w-6 h-6 mr-2 shrink-0" /> ยืนยันการบริจาค</>}
                </button>
            </form>
        </div>
    );
}

// ==========================================
// COMPONENT: Edit Modal
// ==========================================
function EditModal({ donation, userRole, onClose, onSave, showNotification }) {
    const [formData, setFormData] = useState({ ...donation });
    const [securityCode, setSecurityCode] = useState('');
    const [error, setError] = useState('');
    
    const handleSave = () => {
        if (!formData.name) return setError('กรุณาระบุชื่อ-สกุล');
        if (!formData.amount || formData.amount < 0) return setError('จำนวนเงินไม่ถูกต้อง');
        if (userRole === 'staff' && securityCode !== '104') return setError('รหัสลับความปลอดภัยไม่ถูกต้อง');
        
        onSave(formData); 
        onClose();
    };

    return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 animate-scale-up max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-6 pb-2 border-b">
                    <h3 className="text-xl font-bold text-gray-900 flex items-center">
                        <Pencil className="w-5 h-5 mr-2 text-orange-600" /> แก้ไขข้อมูลบริจาค
                    </h3>
                    <button onClick={onClose}><X className="w-5 h-5 text-gray-400" /></button>
                </div>
                <div className="space-y-4">
                    <div className="bg-gray-50 p-2 rounded text-sm text-gray-500">ID: {formData.id}</div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-medium text-gray-500 mb-1">วัน-เวลา</label>
                            <input type="text" disabled className="w-full p-1 border border-gray-300 rounded text-sm bg-gray-100" value={new Date(formData.dateTime).toLocaleString('th-TH')} />
                        </div>
                    </div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">ชื่อ - สกุล</label><input type="text" className="w-full p-2 border border-gray-300 rounded outline-none" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">รายการที่บริจาค</label><input type="text" className="w-full p-2 border border-gray-300 rounded outline-none" value={formData.purpose} onChange={e => setFormData({...formData, purpose: e.target.value})} /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท)</label>
                            <input type="number" className="w-full p-2 border border-gray-300 rounded outline-none font-bold text-orange-600" value={formData.amount} onChange={e => setFormData({...formData, amount: parseFloat(e.target.value)})} />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">ช่องทาง</label>
                            <select className="w-full p-2 border border-gray-300 rounded outline-none bg-white" value={formData.method} onChange={e => setFormData({...formData, method: e.target.value})}>
                                <option value="เงินโอน">เงินโอน</option>
                                <option value="เงินสด">เงินสด</option>
                                <option value="อื่นๆ">อื่นๆ</option>
                            </select>
                        </div>
                    </div>
                    {formData.slipImage && (
                        <div className="mt-2">
                            <label className="block text-sm font-medium text-gray-700 mb-1">สลิปที่แนบมา</label>
                            <img src={formData.slipImage} alt="Slip" className="max-h-40 border rounded" />
                        </div>
                    )}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">สถานะ</label>
                        <select className="w-full p-2 border border-gray-300 rounded outline-none bg-white" value={formData.status} onChange={e => setFormData({...formData, status: e.target.value})}>
                            <option value="pending">รอตรวจสอบ</option>
                            <option value="approved">อนุมัติแล้ว</option>
                            <option value="rejected">ปฏิเสธ</option>
                        </select>
                    </div>
                    <div><label className="block text-sm font-medium text-gray-700 mb-1">หมายเหตุเพิ่มเติม</label><textarea rows="2" className="w-full p-2 border border-gray-300 rounded outline-none" value={formData.generalNote || ''} onChange={e => setFormData({...formData, generalNote: e.target.value})} /></div>
                    <hr className="my-4 border-gray-200" />
                    {userRole === 'staff' && (
                        <div className="bg-red-50 border border-red-200 p-4 rounded-lg">
                            <label className="block text-sm font-bold text-red-700 mb-2 flex items-center">
                                <Key className="w-4 h-4 mr-2" /> ระบุรหัสลับความปลอดภัย
                            </label>
                            <input type="password" placeholder="รหัสลับ (104)" className="w-full p-2 border border-red-300 rounded outline-none focus:ring-2 focus:ring-red-500" value={securityCode} onChange={e => setSecurityCode(e.target.value)} />
                            <p className="text-xs text-red-500 mt-1">* ต้องใส่รหัสลับทุกครั้งเมื่อแก้ไขยอดเงิน</p>
                        </div>
                    )}
                    {error && <div className="text-red-600 text-sm font-medium bg-red-50 p-2 rounded text-center">{error}</div>}
                    <button onClick={handleSave} className="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg flex items-center justify-center transition">
                        <Save className="w-5 h-5 mr-2" /> บันทึกการแก้ไข
                    </button>
                </div>
            </div>
        </div>
    );
}

// ==========================================
// COMPONENT: Dashboard
// ==========================================
function Dashboard({ donations, userRole, onUpdateDonation, showNotification }) {
    const [editingDonation, setEditingDonation] = useState(null);
    const [viewSlip, setViewSlip] = useState(null);
    
    // Simple filter logic for demonstration (filtering handled in memory)
    const filteredData = donations; 
    
    const totalAmount = filteredData.reduce((sum, d) => d.status === 'approved' ? sum + d.amount : sum, 0);
    
    const exportCSV = () => {
        const headers = ["ID", "Date", "Name", "Purpose", "Amount", "Method", "Status", "Note"];
        const rows = filteredData.map(d => [d.id, new Date(d.dateTime).toLocaleString('th-TH'), `"${d.name}"`, `"${d.purpose}"`, d.amount, d.method, d.status, `"${d.generalNote || ''}"`]);
        const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `donation_report_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    return (
        <div className="space-y-6">
            {editingDonation && (
                <EditModal 
                    donation={editingDonation} 
                    userRole={userRole} 
                    onClose={() => setEditingDonation(null)} 
                    onSave={onUpdateDonation} 
                    showNotification={showNotification}
                />
            )}
            {viewSlip && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setViewSlip(null)}>
                    <div className="relative max-w-3xl max-h-full">
                        <img src={viewSlip} alt="Full Slip" className="max-w-full max-h-[90vh] rounded shadow-lg" />
                        <button className="absolute -top-4 -right-4 bg-white rounded-full p-2 shadow" onClick={() => setViewSlip(null)}>
                            <X className="w-6 h-6" />
                        </button>
                    </div>
                </div>
            )}
            
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4 no-print">
                <h2 className="text-xl sm:text-2xl font-bold text-gray-800 flex items-center">
                    <ClipboardList className="w-6 h-6 mr-2 text-orange-600" /> สรุปยอดและรายงาน
                </h2>
                <div className="flex gap-2 w-full sm:w-auto">
                    <button onClick={() => window.print()} className="flex-1 sm:flex-none flex items-center justify-center bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded text-sm transition-colors">
                        <Printer className="w-4 h-4 mr-2" /> พิมพ์ / PDF
                    </button>
                    <button onClick={exportCSV} className="flex-1 sm:flex-none flex items-center justify-center bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm transition-colors">
                        <FileText className="w-4 h-4 mr-2" /> CSV / Excel
                    </button>
                </div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div className="bg-white p-4 rounded-xl shadow-sm border border-orange-100 text-center col-span-2 md:col-span-1">
                    <span className="text-xs sm:text-sm font-medium text-gray-500 block mb-1">ยอดรวม (อนุมัติแล้ว)</span>
                    <span className="text-2xl sm:text-3xl font-bold text-green-600">{totalAmount.toLocaleString()} ฿</span>
                </div>
                <div className="bg-white p-4 rounded-xl shadow-sm border border-orange-100 text-center">
                    <span className="text-xs sm:text-sm font-medium text-gray-500 block mb-1">จำนวนรายการ</span>
                    <span className="text-2xl sm:text-3xl font-bold text-blue-600">{filteredData.length}</span>
                </div>
                <div className="bg-white p-4 rounded-xl shadow-sm border border-orange-100 text-center">
                    <span className="text-xs sm:text-sm font-medium text-gray-500 block mb-1">รอตรวจ</span>
                    <span className="text-2xl sm:text-3xl font-bold text-orange-500">{filteredData.filter(d=>d.status==='pending').length}</span>
                </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border overflow-x-auto print-container">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ข้อมูล</th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">รายการ</th>
                            <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">ยอดเงิน</th>
                            <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">สลิป</th>
                            <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">สถานะ</th>
                            {(userRole === 'admin' || userRole === 'staff') && (
                                <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase no-print">แก้ไข</th>
                            )}
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200 text-sm">
                        {filteredData.map(d => (
                            <tr key={d.id} className="hover:bg-gray-50 break-inside-avoid">
                                <td className="px-4 py-3">
                                    <div className="font-medium text-gray-900">{d.name}</div>
                                    <div className="text-xs text-gray-500">{new Date(d.dateTime).toLocaleDateString('th-TH')}</div>
                                </td>
                                <td className="px-4 py-3">
                                    <div className="text-gray-900 line-clamp-2">{d.purpose}</div>
                                    {d.roongTaanDate && <div className="text-xs text-orange-600">โรงทาน: {d.roongTaanDate} ({d.roongTaanNote})</div>}
                                </td>
                                <td className="px-4 py-3 text-right font-bold">{d.amount.toLocaleString()}</td>
                                <td className="px-4 py-3 text-center">
                                    {d.slipImage ? (
                                        <button onClick={() => setViewSlip(d.slipImage)} className="text-blue-600 hover:underline flex items-center justify-center mx-auto">
                                            <ImageIcon className="w-4 h-4 mr-1" /> ดูรูป
                                        </button>
                                    ) : <span className="text-gray-300">-</span>}
                                </td>
                                <td className="px-4 py-3 text-center">
                                    <span className={`px-2 py-1 text-xs rounded-full ${d.status==='approved'?'bg-green-100 text-green-800':d.status==='pending'?'bg-yellow-100 text-yellow-800':'bg-red-100 text-red-800'}`}>
                                        {d.status==='approved'?'อนุมัติ':d.status==='pending'?'รอตรวจ':'ปฏิเสธ'}
                                    </span>
                                </td>
                                {(userRole === 'admin' || userRole === 'staff') && (
                                    <td className="px-4 py-3 text-center no-print">
                                        <button onClick={() => setEditingDonation(d)} className="text-gray-400 hover:text-orange-600 p-1 hover:bg-orange-50 rounded transition" title="แก้ไขข้อมูล">
                                            <Pencil className="w-4 h-4" />
                                        </button>
                                    </td>
                                )}
                            </tr>
                        ))}
                        {filteredData.length === 0 && (
                            <tr><td colSpan="6" className="text-center py-8 text-gray-500">ไม่พบข้อมูล</td></tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}

// ==========================================
// COMPONENT: Approval Panel
// ==========================================
function ApprovalPanel({ donations, onApprove, onReject }) {
    const pending = donations.filter(d => d.status === 'pending');
    const [viewSlip, setViewSlip] = useState(null);
    
    return (
        <div className="space-y-4 no-print">
            {viewSlip && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setViewSlip(null)}>
                    <div className="relative max-w-3xl max-h-full">
                        <img src={viewSlip} alt="Full Slip" className="max-w-full max-h-[90vh] rounded shadow-lg" />
                        <button className="absolute -top-4 -right-4 bg-white rounded-full p-2 shadow" onClick={() => setViewSlip(null)}>
                            <X className="w-6 h-6" />
                        </button>
                    </div>
                </div>
            )}
            
            <h2 className="text-xl font-bold flex items-center mb-4">
                <ShieldCheck className="w-6 h-6 mr-2 text-orange-600"/> รายการรออนุมัติ ({pending.length})
            </h2>
            
            {pending.length === 0 ? (
                <div className="bg-white p-8 text-center rounded-xl shadow-sm border">
                    <CheckCircle className="w-12 h-12 text-green-400 mx-auto mb-2" />
                    <h3 className="font-medium text-gray-600">ไม่มีรายการค้างตรวจสอบ</h3>
                </div>
            ) : (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {pending.map(d => (
                        <div key={d.id} className="bg-white rounded-xl shadow border border-yellow-200 flex flex-col">
                            <div className="p-4 flex-grow">
                                <div className="text-xs text-gray-500 mb-1">{new Date(d.dateTime).toLocaleString('th-TH')}</div>
                                <div className="font-bold text-lg mb-2">{d.name}</div>
                                <div className="text-sm space-y-1 text-gray-600 mb-3">
                                    <div className="line-clamp-2"><span className="font-medium">รายการ:</span> {d.purpose}</div>
                                    <div><span className="font-medium">ช่องทาง:</span> {d.method}</div>
                                    {d.slipImage && (
                                        <div className="mt-2">
                                            <button onClick={() => setViewSlip(d.slipImage)} className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded flex items-center w-fit hover:bg-blue-100">
                                                <ImageIcon className="w-3 h-3 mr-1" /> ดูสลิปโอนเงิน
                                            </button>
                                        </div>
                                    )}
                                </div>
                                <div className="text-xl font-bold text-orange-600 mb-2">{d.amount.toLocaleString()} ฿</div>
                                {d.generalNote && <div className="text-xs text-gray-500 italic bg-gray-50 p-2 rounded">"{d.generalNote}"</div>}
                            </div>
                            <div className="flex border-t bg-gray-50">
                                <button onClick={() => onApprove(d.id)} className="flex-1 py-3 text-green-700 font-bold hover:bg-green-100 flex justify-center border-r transition-colors">
                                    <Check className="w-5 h-5 mr-1"/> อนุมัติ
                                </button>
                                <button onClick={() => onReject(d.id)} className="flex-1 py-3 text-red-600 font-bold hover:bg-red-50 flex justify-center transition-colors">
                                    <X className="w-5 h-5 mr-1"/> ปฏิเสธ
                                </button>
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

// ==========================================
// COMPONENT: Announcer Panel
// ==========================================
function AnnouncerPanel({ donations, onUpdateStatus }) {
    const approvedDonations = useMemo(() => donations.filter(d => d.status === 'approved'), [donations]);
    const waitingQueue = approvedDonations.filter(d => !d.announced);
    const announcedHistory = approvedDonations.filter(d => d.announced);
    const currentDonor = waitingQueue.length > 0 ? waitingQueue[0] : null;

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between mb-2">
                <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                    <Megaphone className="w-7 h-7 mr-2 text-orange-600" /> สำหรับโฆษก / ประกาศรายชื่อ
                </h2>
                <div className="text-sm bg-orange-100 text-orange-800 px-3 py-1 rounded-full border border-orange-200">
                    รอประกาศ: <strong>{waitingQueue.length}</strong> | ประกาศแล้ว: <strong>{announcedHistory.length}</strong>
                </div>
            </div>
            
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 space-y-4">
                    <div className="bg-white rounded-2xl shadow-lg border-2 border-orange-200 overflow-hidden relative min-h-[400px] flex flex-col justify-center items-center p-8 text-center">
                        {currentDonor ? (
                            <div className="w-full animate-fade-in">
                                <div className="absolute top-4 left-4 bg-yellow-100 text-yellow-800 px-4 py-1 rounded-full text-sm font-bold flex items-center">
                                    <Mic className="w-4 h-4 mr-2" /> กำลังรอประกาศ
                                </div>
                                <div className="mb-2 text-gray-500 text-xl">ลำดับต่อไป...</div>
                                <h1 className="text-5xl md:text-6xl font-bold text-gray-900 mb-6 leading-tight break-words">{currentDonor.name}</h1>
                                
                                <div className="bg-orange-50 rounded-xl p-6 mb-8 w-full border border-orange-100 text-left">
                                    <div className="mb-4 border-b border-orange-200 pb-4">
                                        <span className="block text-gray-500 text-lg mb-2">รายการที่บริจาค:</span>
                                        <ul className="text-2xl font-semibold text-gray-800 space-y-2">
                                            {currentDonor.purpose.split(', ').map((item, i) => (
                                                <li key={i} className="flex items-start">
                                                    <span className="mr-2">•</span> {item}
                                                </li>
                                            ))}
                                            {currentDonor.roongTaanDate && (
                                                <li className="flex items-start text-orange-700">
                                                    <span className="mr-2">•</span> โรงทานวันที่ {new Date(currentDonor.roongTaanDate).toLocaleDateString('th-TH')} ({currentDonor.roongTaanNote})
                                                </li>
                                            )}
                                        </ul>
                                    </div>
                                    <div className="flex justify-between items-end mb-4">
                                        <div>
                                            <span className="block text-gray-500 text-lg">ช่องทาง:</span>
                                            <span className="text-xl font-medium">{currentDonor.method}</span>
                                        </div>
                                        <div className="text-right">
                                            <span className="block text-gray-500 text-lg">ยอดเงินรวม:</span>
                                            <span className="text-4xl font-bold text-orange-600">{currentDonor.amount.toLocaleString()} บาท</span>
                                        </div>
                                    </div>
                                    {currentDonor.generalNote && (
                                        <div className="mt-4 pt-4 border-t border-orange-200 bg-white p-4 rounded-lg border">
                                            <span className="block text-gray-500 text-lg mb-1">หมายเหตุ / คำอวยพร:</span>
                                            <span className="text-2xl italic text-gray-800">"{currentDonor.generalNote}"</span>
                                        </div>
                                    )}
                                </div>
                                
                                <button onClick={() => onUpdateStatus(currentDonor.id, true)} className="w-full max-w-md bg-green-600 hover:bg-green-700 text-white text-2xl font-bold py-5 px-8 rounded-full shadow-lg transform transition hover:scale-105 flex items-center justify-center mx-auto">
                                    <Megaphone className="w-8 h-8 mr-3" /> ประกาศแล้ว (ถัดไป)
                                </button>
                            </div>
                        ) : (
                            <div className="text-gray-400 flex flex-col items-center">
                                <CheckCircle className="w-20 h-20 mb-4 opacity-50" />
                                <h3 className="text-3xl font-bold">ประกาศครบทุกรายการแล้ว</h3>
                                <p className="mt-2 text-lg">ไม่มีรายการรอประกาศในขณะนี้</p>
                            </div>
                        )}
                    </div>
                </div>
                
                <div className="space-y-6">
                    <div className="bg-white rounded-xl shadow border p-4 max-h-[300px] overflow-y-auto">
                        <h3 className="text-lg font-bold text-gray-700 mb-3 border-b pb-2 flex items-center sticky top-0 bg-white">
                            <div className="w-2 h-2 rounded-full bg-yellow-400 mr-2"></div> คิวรอถัดไป ({Math.max(0, waitingQueue.length - 1)})
                        </h3>
                        {waitingQueue.slice(1).length > 0 ? (
                            <ul className="space-y-2">
                                {waitingQueue.slice(1).map(d => (
                                    <li key={d.id} className="p-3 bg-gray-50 rounded border flex justify-between items-center">
                                        <span className="font-medium truncate mr-2">{d.name}</span>
                                        <span className="text-orange-600 font-bold text-sm whitespace-nowrap">{d.amount.toLocaleString()}</span>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-gray-400 text-sm text-center py-4">ไม่มีคิวรอ</p>
                        )}
                    </div>
                    
                    <div className="bg-white rounded-xl shadow border p-4 max-h-[300px] overflow-y-auto">
                        <h3 className="text-lg font-bold text-gray-700 mb-3 border-b pb-2 flex items-center sticky top-0 bg-white">
                            <div className="w-2 h-2 rounded-full bg-green-500 mr-2"></div> ประกาศแล้ว ({announcedHistory.length})
                        </h3>
                        {announcedHistory.length > 0 ? (
                            <ul className="space-y-2">
                                {announcedHistory.slice().reverse().map(d => (
                                    <li key={d.id} className="p-3 bg-green-50 border border-green-100 rounded flex justify-between items-center group">
                                        <div className="flex flex-col truncate mr-2">
                                            <span className="font-medium text-gray-700 truncate">{d.name}</span>
                                            <span className="text-xs text-green-600">ประกาศแล้ว</span>
                                        </div>
                                        <button onClick={() => onUpdateStatus(d.id, false)} className="text-gray-400 hover:text-red-500 p-1 rounded hover:bg-red-50 transition opacity-0 group-hover:opacity-100" title="ย้อนกลับ (Undo)">
                                            <RotateCcw className="w-4 h-4" />
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-gray-400 text-sm text-center py-4">ยังไม่มีประวัติ</p>
                        )}
                    </div>
                </div>
            </div>
        </div>
    );
}
