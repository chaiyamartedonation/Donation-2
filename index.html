<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>วัดไชยามาตย์ - ระบบรับบริจาคออนไลน์</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@300;400;500;600&family=Kanit:wght@300;400;500;600&family=Mitr:wght@300;400;500&family=Mali:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                        prompt: ['Prompt', 'sans-serif'],
                        kanit: ['Kanit', 'sans-serif'],
                        mitr: ['Mitr', 'sans-serif'],
                        mali: ['Mali', 'cursive'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'scale-up': 'scaleUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        scaleUp: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                    }
                }
            },
            // Safelist for dynamic color classes
            safelist: [
                { pattern: /bg-(orange|yellow|red|green|emerald|blue|stone)-(50|100|200|300|400|500|600|700|800|900)/ },
                { pattern: /text-(orange|yellow|red|green|emerald|blue|stone)-(50|100|200|300|400|500|600|700|800|900)/ },
                { pattern: /border-(orange|yellow|red|green|emerald|blue|stone)-(100|200|300|400|500|600)/ },
                { pattern: /ring-(orange|yellow|red|green|emerald|blue|stone)-(500)/ },
                { pattern: /hover:bg-(orange|yellow|red|green|emerald|blue|stone)-(600|700|800)/ }
            ]
        }
    </script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-container { width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Home, PlusCircle, ClipboardList, CheckCircle, User, ShieldCheck, Filter, 
            Check, X, ArrowLeft, HeartHandshake, MapPin, Phone, Calendar, BookOpen, 
            Menu, ChevronRight, Download, Printer, Lock, LogOut, FileText, Megaphone, 
            Mic, RotateCcw, CalendarDays, Pencil, Save, Key, QrCode, ShoppingBag, 
            UploadCloud, Image as ImageIcon, Loader, Info, Settings, Trash2, AlertTriangle, 
            Plus, LogIn, Facebook, MessageCircle, Palette, Bell, FileCheck, Type
        } from 'https://esm.sh/lucide-react@0.344.0';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, setDoc, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAHuvRRTNpYuh8MFiIwN4Lm106l09BED14",
            authDomain: "donation-1b152.firebaseapp.com",
            projectId: "donation-1b152",
            storageBucket: "donation-1b152.firebasestorage.app",
            messagingSenderId: "203853712269",
            appId: "1:203853712269:web:80441cd834e7b0e68dcbc4",
            measurementId: "G-10ZKFX0TET"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'temple-donation-app-full-v1'; 

        // --- CONSTANTS ---
        const DEFAULT_SETTINGS = {
            systemStatus: 'open',
            templeName: 'วัดไชยามาตย์',
            themeColor: 'orange',
            fontFamily: 'Sarabun',
            bannerUrl: 'https://images.unsplash.com/photo-1590484501469-808ceea194f4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
            qrCodeUrl: 'https://img2.pic.in.th/pic/099400240646898.png',
            marqueeText: 'ขอเชิญร่วมทำบุญตามกำลังศรัทธา... สะสมบุญ นำสุขมาให้',
            requireSlip: true,
            passwords: { staff: '104', admin: 'admin104' },
            bankInfo: { bankName: 'ธ.กรุงไทย', accountName: 'วัดไชยามาตย์', accountNumber: 'xxx-x-xxxxx-x' },
            contact: { phone: '082-2801992', address: 'หมู่ที่ 1 ตำบลเวียงทอง อำเภอสูงเม่น จังหวัดแพร่ 54130', facebook: '', line: '' },
            messages: { thankYou: 'ขออนุโมทนาบุญ ขอให้ท่านและครอบครัวมีความสุขความเจริญ ปราศจากโรคภัยไข้เจ็บ' },
            donationTypes: [
                { id: 'general', name: 'บริจาคทั่วไป / ค่าน้ำค่าไฟ', hasQuantity: false, price: 0, active: true },
                { id: 'thai_taan', name: 'ไทยทาน', hasQuantity: true, price: 300, unit: 'ชุด', active: true },
                { id: 'hua_wat', name: 'หัววัด', hasQuantity: true, price: 500, unit: 'ชุด', active: true },
                { id: 'roong_taan', name: 'จองโรงทาน', isSpecial: true, active: true }
            ]
        };

        const FONT_OPTIONS = [
            { id: 'Sarabun', name: 'Sarabun (ทางการ)' },
            { id: 'Prompt', name: 'Prompt (ทันสมัย)' },
            { id: 'Kanit', name: 'Kanit (ยอดนิยม)' },
            { id: 'Mitr', name: 'Mitr (เป็นมิตร)' },
            { id: 'Mali', name: 'Mali (ลายมือ)' },
        ];

        const resizeImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scaleSize;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const NotificationToast = ({ msg, onClose, type = 'success' }) => {
            if (!msg) return null;
            const bgColor = type === 'success' ? 'bg-green-100 border-green-500 text-green-800' : 'bg-red-100 border-red-500 text-red-800';
            return (
                <div className={`fixed top-4 right-4 z-[100] flex items-center p-4 mb-4 rounded-lg border-l-4 shadow-lg animate-fade-in ${bgColor}`}>
                    <div className="text-sm font-medium">{msg}</div>
                    <button onClick={onClose} className="ml-4 hover:opacity-70"><X className="w-4 h-4" /></button>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [currentRoute, setCurrentRoute] = useState('home');
            const [donations, setDonations] = useState([]);
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            const [loading, setLoading] = useState(true);
            const [user, setUser] = useState(null);
            const [notification, setNotification] = useState(null);

            const showNotification = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            useEffect(() => {
                const initAuth = async () => {
                    try { await signInAnonymously(auth); } catch (error) { console.error("Auth error:", error); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config');
                const unsubscribe = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setSettings(prev => ({
                            ...DEFAULT_SETTINGS,
                            ...data,
                            passwords: { ...DEFAULT_SETTINGS.passwords, ...data.passwords },
                            bankInfo: { ...DEFAULT_SETTINGS.bankInfo, ...data.bankInfo },
                            contact: { ...DEFAULT_SETTINGS.contact, ...data.contact },
                            messages: { ...DEFAULT_SETTINGS.messages, ...data.messages },
                            donationTypes: data.donationTypes || DEFAULT_SETTINGS.donationTypes
                        }));
                    } else {
                        setDoc(settingsRef, DEFAULT_SETTINGS).catch(err => console.warn("Init settings failed:", err));
                    }
                }, (error) => console.error("Settings error:", error));
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'donations'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    docs.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
                    setDonations(docs);
                    setLoading(false);
                }, (error) => {
                    console.error("Donations error:", error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const handleAddDonation = async (newDonation) => {
                try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'donations'), newDonation); showNotification('บันทึกข้อมูลสำเร็จ'); } catch (e) { showNotification("เกิดข้อผิดพลาด: " + e.message, 'error'); }
            };
            const handleUpdateDonation = async (updatedDonation) => {
                try { const { id, ...data } = updatedDonation; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'donations', id), data); showNotification('อัปเดตข้อมูลสำเร็จ'); } catch (e) { showNotification("แก้ไขไม่สำเร็จ: " + e.message, 'error'); }
            };
            const handleUpdateSettings = async (newSettings) => {
                try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'config'), newSettings); showNotification('บันทึกการตั้งค่าเรียบร้อย'); } catch (e) { showNotification("ตั้งค่าไม่สำเร็จ: " + e.message, 'error'); }
            };
            const handleClearAllData = async () => {
                try { const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'donations')); const snapshot = await getDocs(q); const batch = writeBatch(db); snapshot.docs.forEach((doc) => batch.delete(doc.ref)); await batch.commit(); showNotification('ล้างข้อมูลเรียบร้อย'); } catch (e) { showNotification("ล้างข้อมูลไม่สำเร็จ: " + e.message, 'error'); }
            };

            const font = settings.fontFamily || 'Sarabun';
            const theme = settings.themeColor || 'orange';

            return (
                <div className={`font-${font.toLowerCase()} text-gray-800 antialiased`}>
                    <style>{`
                        body, button, input, select, textarea { font-family: '${font}', sans-serif !important; }
                        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
                        .animate-marquee { animation: marquee 25s linear infinite; }
                    `}</style>
                    {notification && <NotificationToast msg={notification.msg} type={notification.type} onClose={() => setNotification(null)} />}
                    
                    {loading ? (
                        <div className="min-h-screen flex flex-col items-center justify-center bg-orange-50 text-orange-600">
                            <Loader className="w-10 h-10 animate-spin mb-4" /><p>กำลังเชื่อมต่อฐานข้อมูล...</p>
                        </div>
                    ) : currentRoute === 'donate-system' ? (
                        <DonationSystem onBack={() => setCurrentRoute('home')} donations={donations} settings={settings} onAdd={handleAddDonation} onUpdate={handleUpdateDonation} onUpdateSettings={handleUpdateSettings} onClearData={handleClearAllData} showNotification={showNotification} user={user} />
                    ) : (
                        <OfficialWebsite onNavigate={(route) => setCurrentRoute(route)} donations={donations} settings={settings} />
                    )}
                </div>
            );
        }

        // --- OFFICIAL WEBSITE ---
        function OfficialWebsite({ onNavigate, donations, settings }) {
            const [isScrolled, setIsScrolled] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const totalAmount = useMemo(() => donations.filter(d => d.status === 'approved').reduce((sum, d) => sum + d.amount, 0), [donations]);
            const theme = settings.themeColor || 'orange';

            useEffect(() => {
                const handleScroll = () => setIsScrolled(window.scrollY > 50);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            if (settings.systemStatus === 'maintenance') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 text-gray-600 p-4 text-center relative">
                        <AlertTriangle className="w-16 h-16 text-yellow-500 mb-4" />
                        <h1 className="text-3xl font-bold mb-2">ปิดปรับปรุงชั่วคราว</h1>
                        <p>ระบบกำลังดำเนินการปรับปรุง ขออภัยในความไม่สะดวก</p>
                        <p className="mt-4 text-sm text-gray-500">{settings.templeName}</p>
                        <button onClick={() => onNavigate('donate-system')} className={`absolute top-4 right-4 p-2 text-gray-400 hover:text-${theme}-600 transition-colors flex items-center gap-1 group`} title="ผู้ดูแลระบบ">
                            <span className="text-xs opacity-0 group-hover:opacity-100 transition-opacity">Admin</span><Lock className="w-5 h-5" />
                        </button>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen bg-${theme}-50 text-gray-800 scroll-smooth`}>
                    {settings.marqueeText && <div className={`bg-${theme}-800 text-white text-sm py-2 overflow-hidden relative z-[60]`}><div className="whitespace-nowrap animate-marquee px-4">{settings.marqueeText}</div></div>}
                    
                    <nav className={`fixed w-full z-50 transition-all duration-300 ${isScrolled ? 'bg-white shadow-md py-2' : 'bg-transparent py-4'} ${settings.marqueeText ? 'top-8' : 'top-0'}`}>
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center ${isScrolled ? `bg-${theme}-600 text-white` : `bg-white text-${theme}-600`}`}><BookOpen className="w-6 h-6" /></div>
                                    <span className={`text-xl font-bold ${isScrolled ? `text-${theme}-800` : 'text-white drop-shadow-md'}`}>{settings.templeName}</span>
                                </div>
                                <div className="hidden md:flex items-center space-x-8">
                                    <button onClick={() => onNavigate('donate-system')} className={`${settings.systemStatus === 'open' ? `bg-${theme}-600 hover:bg-${theme}-700` : 'bg-gray-600 hover:bg-gray-700'} text-white px-6 py-2 rounded-full font-bold flex items-center transition-transform hover:scale-105 shadow-lg`}>
                                        {settings.systemStatus === 'open' ? <><HeartHandshake className="w-5 h-5 mr-2" /> ร่วมทำบุญ</> : <><Lock className="w-4 h-4 mr-2" /> เข้าสู่ระบบ (จนท.)</>}
                                    </button>
                                </div>
                                <div className="md:hidden"><button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className={isScrolled ? 'text-gray-800' : 'text-white'}>{mobileMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}</button></div>
                            </div>
                        </div>
                        {mobileMenuOpen && (
                            <div className="md:hidden bg-white absolute top-full left-0 w-full shadow-lg border-t border-gray-100">
                                <div className="px-4 pt-2 pb-4 space-y-1 flex flex-col">
                                    <button onClick={() => onNavigate('donate-system')} className={`mt-4 w-full ${settings.systemStatus === 'open' ? `bg-${theme}-600` : 'bg-gray-600'} text-white px-4 py-3 rounded-md font-bold flex justify-center items-center`}>
                                        {settings.systemStatus === 'open' ? <><HeartHandshake className="w-5 h-5 mr-2" /> ร่วมทำบุญออนไลน์</> : <><Lock className="w-4 h-4 mr-2" /> เข้าสู่ระบบ (จนท.)</>}
                                    </button>
                                </div>
                            </div>
                        )}
                    </nav>

                    <section id="home" className="relative h-[85vh] flex items-center justify-center bg-gray-900">
                        <div className="absolute inset-0 w-full h-full">
                            <img src={settings.bannerUrl} onError={(e) => e.target.style.display = 'none'} alt="ภาพวัด" className="w-full h-full object-cover opacity-60" />
                            <div className="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
                        </div>
                        <div className="relative z-20 text-center px-4 max-w-4xl mx-auto">
                            <span className={`block text-${theme}-400 font-semibold tracking-wider mb-2`}>ยินดีต้อนรับสู่</span>
                            <h1 className="text-5xl md:text-7xl font-bold text-white mb-6 leading-tight drop-shadow-lg">{settings.templeName}</h1>
                            <div className="mb-10 inline-block">
                                <div className="backdrop-blur-md bg-white/10 border border-white/30 rounded-2xl p-6 shadow-2xl">
                                    <p className={`text-${theme}-200 text-sm md:text-base font-medium mb-1 uppercase tracking-widest`}>ยอดบริจาครวมทั้งหมด</p>
                                    <div className="text-4xl md:text-6xl font-bold text-white drop-shadow-sm">฿ {totalAmount.toLocaleString()}</div>
                                </div>
                            </div>
                            <div>
                                {settings.systemStatus === 'open' ? (
                                    <button onClick={() => onNavigate('donate-system')} className={`bg-${theme}-600 hover:bg-${theme}-700 text-white px-8 py-4 rounded-full font-bold text-lg flex items-center justify-center transition-transform hover:scale-105 shadow-xl border-2 border-${theme}-500`}>
                                        <HeartHandshake className="w-6 h-6 mr-2" /> ร่วมบริจาค / จองโรงทาน
                                    </button>
                                ) : (
                                    <button onClick={() => onNavigate('donate-system')} className="bg-red-500/80 backdrop-blur text-white px-6 py-3 rounded-lg inline-flex items-center hover:bg-red-600/90 transition-colors cursor-pointer" title="คลิกเพื่อเข้าสู่ระบบเจ้าหน้าที่">
                                        <Lock className="w-4 h-4 mr-2" /> ขณะนี้ปิดรับบริจาคชั่วคราว (Admin Click)
                                    </button>
                                )}
                            </div>
                        </div>
                    </section>

                    <footer className="bg-gray-900 text-white pt-16 pb-8">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-12 mb-12 border-b border-gray-800 pb-12">
                                <div>
                                    <div className="flex items-center gap-3 mb-6"><div className={`w-10 h-10 rounded-full bg-${theme}-600 flex items-center justify-center text-white`}><BookOpen className="w-6 h-6" /></div><span className="text-2xl font-bold text-white">{settings.templeName}</span></div>
                                    <div className="flex space-x-4 mt-4">
                                        {settings.contact.facebook && <a href={settings.contact.facebook} target="_blank" className="text-gray-400 hover:text-white"><Facebook className="w-6 h-6" /></a>}
                                        {settings.contact.line && <a href={settings.contact.line} target="_blank" className="text-gray-400 hover:text-white"><MessageCircle className="w-6 h-6" /></a>}
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-lg font-bold mb-6 text-white">ข้อมูลติดต่อ</h3>
                                    <ul className="space-y-4">
                                        <li className="flex items-start"><MapPin className={`w-5 h-5 text-${theme}-500 mr-3 mt-1 flex-shrink-0`} /><span className="text-gray-400">{settings.contact.address}</span></li>
                                        <li className="flex items-center"><Phone className={`w-5 h-5 text-${theme}-500 mr-3 flex-shrink-0`} /><span className="text-gray-400">{settings.contact.phone}</span></li>
                                    </ul>
                                </div>
                            </div>
                            <div className="text-center text-gray-500 text-sm"><p>&copy; {new Date().getFullYear()} {settings.templeName}. All rights reserved.</p></div>
                        </div>
                    </footer>
                </div>
            );
        }

        // --- DONATION SYSTEM CONTAINER ---
        function DonationSystem({ onBack, donations, settings, onAdd, onUpdate, onUpdateSettings, onClearData, showNotification, user }) {
            const [activeTab, setActiveTab] = useState('donate');
            const [userRole, setUserRole] = useState('donor');
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [pendingRole, setPendingRole] = useState(null);
            const theme = settings.themeColor || 'orange';

            const handleRoleSwitch = (newRole) => {
                if (newRole === 'donor') { setUserRole('donor'); setIsAuthenticated(false); setActiveTab('donate'); }
                else { setPendingRole(newRole); setShowLoginModal(true); }
            };
            const handleLogout = () => { setUserRole('donor'); setIsAuthenticated(false); setActiveTab('donate'); showNotification('ออกจากระบบเรียบร้อยแล้ว'); };
            const toggleAnnounced = (id, status) => { const item = donations.find(d => d.id === id); if (item) onUpdate({ ...item, announced: status }); };

            return (
                <div className={`min-h-screen bg-${theme}-50 text-gray-800 no-print`}>
                    {showLoginModal && <LoginModal role={pendingRole} settings={settings} onClose={() => setShowLoginModal(false)} onLoginSuccess={() => { setUserRole(pendingRole); setIsAuthenticated(true); setShowLoginModal(false); showNotification(`เข้าสู่ระบบ ${pendingRole} สำเร็จ`); }} />}
                    <header className={`bg-${theme}-600 text-white shadow-md no-print`}>
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4 w-full sm:w-auto">
                                <button onClick={onBack} className={`p-2 bg-${theme}-700 hover:bg-${theme}-800 rounded-full transition-colors shrink-0`} title="กลับหน้าหลัก"><ArrowLeft className="w-6 h-6" /></button>
                                <div><h1 className="text-xl sm:text-2xl font-bold">ระบบรับบริจาค{settings.templeName}</h1><p className={`text-xs sm:text-sm text-${theme}-200`}>ระบบจัดการออนไลน์</p></div>
                            </div>
                            <div className={`flex items-center gap-2 text-sm bg-${theme}-700 p-2 rounded-lg`}>
                                {isAuthenticated ? 
                                    <><User className={`w-5 h-5 text-${theme}-200`} /><span className="font-medium">{userRole === 'staff' ? 'จนท.' : 'Admin'}</span><button onClick={handleLogout} className="bg-red-500 p-1 rounded ml-2"><LogOut className="w-4 h-4 text-white" /></button></> :
                                    <><Lock className="w-3 h-3 text-white"/><select className="bg-white text-gray-800 rounded px-2 py-1 outline-none text-xs" value={userRole} onChange={(e) => handleRoleSwitch(e.target.value)}><option value="donor">ผู้บริจาค</option><option value="staff">จนท.</option><option value="admin">Admin</option></select></>
                                }
                            </div>
                        </div>
                    </header>
                    <nav className="bg-white shadow-sm sticky top-0 z-10 no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex space-x-4 overflow-x-auto hide-scrollbar">
                                <button onClick={() => setActiveTab('donate')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'donate' ? `border-${theme}-500 text-${theme}-600` : 'border-transparent text-gray-500'}`}><PlusCircle className="w-5 h-5 mr-2 shrink-0" /> {userRole === 'donor' ? 'บริจาค' : 'บันทึกรับเงิน'}</button>
                                {isAuthenticated && <button onClick={() => setActiveTab('dashboard')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'dashboard' ? `border-${theme}-500 text-${theme}-600` : 'border-transparent text-gray-500'}`}><ClipboardList className="w-5 h-5 mr-2" /> สรุปยอด</button>}
                                {isAuthenticated && <button onClick={() => setActiveTab('announcer')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'announcer' ? `border-${theme}-500 text-${theme}-600` : 'border-transparent text-gray-500'}`}><Megaphone className="w-5 h-5 mr-2" /> โฆษก</button>}
                                {isAuthenticated && userRole === 'admin' && <><button onClick={() => setActiveTab('approval')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'approval' ? `border-${theme}-500 text-${theme}-600` : 'border-transparent text-gray-500'}`}><CheckCircle className="w-5 h-5 mr-2" /> อนุมัติ</button><button onClick={() => setActiveTab('settings')} className={`flex items-center px-4 py-3 border-b-2 font-medium whitespace-nowrap ${activeTab === 'settings' ? `border-${theme}-500 text-${theme}-600` : 'border-transparent text-gray-500'}`}><Settings className="w-5 h-5 mr-2" /> ตั้งค่า</button></>}
                            </div>
                        </div>
                    </nav>
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-20 print-container">
                        {activeTab === 'donate' && <DonationForm userRole={userRole} settings={settings} onSave={onAdd} showNotification={showNotification} />}
                        {activeTab === 'dashboard' && isAuthenticated && <Dashboard donations={donations} userRole={userRole} onUpdateDonation={onUpdate} showNotification={showNotification} />}
                        {activeTab === 'announcer' && isAuthenticated && <AnnouncerPanel donations={donations} onUpdateStatus={toggleAnnounced} settings={settings} />}
                        {activeTab === 'approval' && userRole === 'admin' && isAuthenticated && <ApprovalPanel donations={donations} onApprove={(id) => { const d = donations.find(x => x.id === id); if(d) onUpdate({...d, status: 'approved'}); }} onReject={(id) => { const d = donations.find(x => x.id === id); if(d) onUpdate({...d, status: 'rejected'}); }} />}
                        {activeTab === 'settings' && userRole === 'admin' && isAuthenticated && <AdminSettingsPanel settings={settings} onSave={onUpdateSettings} onClearData={onClearData} />}
                    </main>
                </div>
            );
        }

        // --- FULL DONATION FORM ---
        function DonationForm({ userRole, onSave, showNotification, settings }) {
            const [name, setName] = useState('');
            const [method, setMethod] = useState('เงินโอน');
            const [generalNote, setGeneralNote] = useState('');
            const [slipImage, setSlipImage] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [selectedItems, setSelectedItems] = useState({});
            const theme = settings.themeColor || 'orange';

            useEffect(() => {
                const initial = {};
                settings.donationTypes.forEach(type => { if (type.active) initial[type.id] = { checked: false, quantity: 1, amount: type.price || '' }; });
                if (settings.donationTypes.find(t => t.id === 'roong_taan')?.active) initial['roong_taan'] = { checked: false, date: '', note: '' };
                setSelectedItems(prev => ({ ...initial, ...prev }));
            }, [settings.donationTypes]);

            const totalAmount = useMemo(() => {
                let sum = 0;
                settings.donationTypes.forEach(type => {
                    if (selectedItems[type.id]?.checked && !type.isSpecial) {
                        if (type.hasQuantity) sum += (selectedItems[type.id].quantity || 1) * type.price;
                        else sum += Number(selectedItems[type.id].amount || 0);
                    }
                });
                return sum;
            }, [selectedItems, settings.donationTypes]);

            const handleFileChange = async (e) => {
                if (e.target.files[0]) { setIsUploading(true); try { setSlipImage(await resizeImage(e.target.files[0])); } catch (err) { showNotification("อ่านไฟล์รูปไม่ได้", 'error'); } setIsUploading(false); }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (settings.systemStatus === 'closed') return showNotification('ปิดรับบริจาคชั่วคราว', 'error');
                if (!name) return showNotification('กรุณาระบุชื่อ-สกุล', 'error');
                const isRoongTaanChecked = selectedItems['roong_taan']?.checked;
                if (totalAmount <= 0 && !isRoongTaanChecked) return showNotification('กรุณาระบุยอดเงิน', 'error');
                if (settings.requireSlip !== false && method === 'เงินโอน' && !slipImage && userRole === 'donor') return showNotification('กรุณาแนบสลิป', 'error');

                let purposeParts = [];
                settings.donationTypes.forEach(type => {
                    const item = selectedItems[type.id];
                    if (item?.checked) {
                        if (type.isSpecial && type.id === 'roong_taan') purposeParts.push(`จองโรงทาน`);
                        else if (type.hasQuantity) purposeParts.push(`${type.name} ${item.quantity} ${type.unit} (${(item.quantity * type.price).toLocaleString()} บาท)`);
                        else purposeParts.push(`${type.name} ${Number(item.amount).toLocaleString()} บาท`);
                    }
                });

                onSave({ 
                    dateTime: new Date().toISOString(), name, purpose: purposeParts.join(', '), amount: totalAmount, method, generalNote, 
                    status: userRole === 'donor' ? 'pending' : 'approved', source: userRole === 'donor' ? 'self' : 'staff', announced: false,
                    roongTaanDate: isRoongTaanChecked ? selectedItems['roong_taan'].date : null,
                    roongTaanNote: isRoongTaanChecked ? selectedItems['roong_taan'].note : null, slipImage 
                });
                setName(''); setMethod('เงินโอน'); setGeneralNote(''); setSlipImage(null);
                const resetItems = {}; Object.keys(selectedItems).forEach(k => resetItems[k] = { ...selectedItems[k], checked: false, amount: '', quantity: 1, date: '', note: '' });
                setSelectedItems(resetItems);
            };

            if (settings.systemStatus === 'closed' && userRole === 'donor') return <div className="max-w-2xl mx-auto bg-white rounded-xl shadow p-8 text-center text-red-600"><AlertTriangle className="w-16 h-16 mx-auto mb-4" /><h2 className="text-2xl font-bold">ขณะนี้ปิดรับบริจาคชั่วคราว</h2></div>;

            return (
                <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-md overflow-hidden no-print">
                    <div className={`bg-${theme}-100 px-6 py-4 border-b border-${theme}-200 flex justify-between items-center`}>
                        <h2 className={`text-xl font-semibold text-${theme}-800 flex items-center`}><PlusCircle className="w-6 h-6 mr-2" /> {userRole === 'donor' ? 'ฟอร์มแจ้งความประสงค์' : 'บันทึกรับเงิน'}</h2>
                    </div>
                    <form onSubmit={handleSubmit} className="p-6 space-y-6">
                        <div><label className="block text-sm font-medium mb-1">ชื่อ - สกุล ผู้บริจาค *</label><input type="text" required className={`w-full p-2 border rounded focus:ring-2 focus:ring-${theme}-500 outline-none`} value={name} onChange={e => setName(e.target.value)} /></div>
                        
                        <div className="space-y-3">
                            <label className="block text-sm font-medium">เลือกรายการบริจาค</label>
                            {settings.donationTypes.filter(t => t.active).map(type => {
                                const itemState = selectedItems[type.id] || { checked: false, quantity: 1, amount: '' };
                                const isChecked = itemState.checked;
                                return (
                                    <div key={type.id} className={`p-3 rounded-lg border transition-colors ${isChecked ? `bg-${theme}-50 border-${theme}-300` : 'border-gray-200 hover:bg-gray-50'}`}>
                                        <div className="flex items-center mb-2 justify-between">
                                            <div className="flex items-center"><input type="checkbox" className={`w-5 h-5 text-${theme}-600 rounded border-gray-300 focus:ring-${theme}-500`} checked={isChecked} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, checked: e.target.checked}})} /><span className="ml-2 font-medium">{type.name} {type.hasQuantity && `(${type.price}.-)`}</span></div>
                                            {isChecked && type.hasQuantity && <span className={`text-${theme}-600 font-bold`}>{itemState.quantity * type.price} บ.</span>}
                                        </div>
                                        {isChecked && (
                                            <div className="ml-7">
                                                {type.isSpecial && type.id === 'roong_taan' ? (
                                                    <div className="space-y-2"><input type="date" className="w-full p-2 border rounded text-sm" value={itemState.date || ''} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, date: e.target.value}})} required /><input type="text" placeholder="ระบุสิ่งของ (เช่น ข้าวมันไก่)" className="w-full p-2 border rounded text-sm" value={itemState.note || ''} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, note: e.target.value}})} required /></div>
                                                ) : type.hasQuantity ? (
                                                    <div className="flex items-center gap-2"><button type="button" className="px-3 py-1 bg-gray-200 rounded" onClick={() => setSelectedItems(prev => ({...prev, [type.id]: {...itemState, quantity: Math.max(1, (itemState.quantity || 1) - 1)}}))}>-</button><input type="number" className="w-16 text-center border-none bg-transparent font-bold" value={itemState.quantity || 1} readOnly /><button type="button" className="px-3 py-1 bg-gray-200 rounded" onClick={() => setSelectedItems(prev => ({...prev, [type.id]: {...itemState, quantity: (itemState.quantity || 1) + 1}}))}>+</button><span className="text-gray-500">{type.unit}</span></div>
                                                ) : (
                                                    <div className="flex items-center gap-2"><input type="number" min="1" placeholder="ระบุจำนวนเงิน" className="w-full p-2 border rounded" value={itemState.amount} onChange={e => setSelectedItems({...selectedItems, [type.id]: {...itemState, amount: e.target.value}})} /><span className="text-gray-500">บาท</span></div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>

                        <div className={`bg-${theme}-50 p-4 rounded-xl flex justify-between items-center border border-${theme}-100`}><span className="font-semibold">ยอดรวมทั้งสิ้น</span><span className={`text-2xl font-bold text-${theme}-600`}>{totalAmount.toLocaleString()} บาท</span></div>
                        
                        <div className="bg-gray-50 rounded-lg border p-4">
                            {userRole !== 'donor' ? <div className="text-green-600 text-center font-medium"><CheckCircle className="inline mr-2"/>ยืนยันการรับเงินแล้ว</div> : method === 'เงินโอน' ? (
                                <div className="text-center space-y-4">
                                    <div><p className="text-sm font-bold mb-2">1. สแกน QR Code</p><img src={settings.qrCodeUrl} className="w-40 h-40 object-contain mx-auto bg-white p-2 rounded border" /><p className="text-xs mt-1">{settings.bankInfo?.bankName} | {settings.bankInfo?.accountNumber}</p></div>
                                    <div className="border-t pt-4"><p className="text-sm font-bold mb-2">2. แนบสลิป</p><label className="block border-2 border-dashed rounded-lg p-4 cursor-pointer hover:bg-gray-100"><div className="flex flex-col items-center"><UploadCloud className="w-6 h-6 text-gray-400"/><span className="text-sm text-gray-600">คลิกเลือกรูป</span></div><input type="file" className="hidden" onChange={handleFileChange}/></label>{slipImage && <div className="mt-2"><img src={slipImage} className="h-20 mx-auto border rounded"/><button type="button" onClick={()=>setSlipImage(null)} className="text-red-500 text-xs">ลบรูป</button></div>}</div>
                                </div>
                            ) : <div className="text-center text-gray-500"><ShoppingBag className="mx-auto w-8 h-8 mb-2 opacity-50"/>นำเงินสดมาถวายที่วัด</div>}
                        </div>

                        <div><label className="block text-sm font-medium mb-1">หมายเหตุ</label><textarea rows="2" className="w-full p-2 border rounded" value={generalNote} onChange={e => setGeneralNote(e.target.value)}></textarea></div>
                        <button type="submit" disabled={isUploading} className={`w-full text-white font-bold py-3 rounded hover:bg-${theme}-700 transition shadow-lg flex justify-center items-center ${isUploading ? 'bg-gray-400' : `bg-${theme}-600`}`}>{isUploading ? 'กำลังอัปโหลด...' : 'ยืนยันการบริจาค'}</button>
                    </form>
                </div>
            );
        }

        // --- DASHBOARD ---
        function Dashboard({ donations, userRole, onUpdateDonation }) {
            const [viewSlip, setViewSlip] = useState(null);
            const [editing, setEditing] = useState(null);
            
            return (
                <div className="space-y-6">
                    {viewSlip && <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setViewSlip(null)}><img src={viewSlip} className="max-h-[90vh] rounded" /></div>}
                    {editing && <EditModal donation={editing} userRole={userRole} onClose={()=>setEditing(null)} onSave={onUpdateDonation}/>}
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-4 rounded shadow border-l-4 border-green-500"><div>ยอดรวม (อนุมัติ)</div><div className="text-2xl font-bold text-green-600">{donations.filter(d=>d.status==='approved').reduce((s,d)=>s+d.amount,0).toLocaleString()} ฿</div></div>
                        <div className="bg-white p-4 rounded shadow border-l-4 border-blue-500"><div>จำนวนรายการ</div><div className="text-2xl font-bold text-blue-600">{donations.length}</div></div>
                        <div className="bg-white p-4 rounded shadow border-l-4 border-orange-500"><div>รอตรวจ</div><div className="text-2xl font-bold text-orange-600">{donations.filter(d=>d.status==='pending').length}</div></div>
                    </div>

                    <div className="bg-white rounded shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50 border-b"><tr><th className="p-3 text-left">วันที่</th><th className="p-3 text-left">ชื่อ</th><th className="p-3 text-right">ยอดเงิน</th><th className="p-3 text-center">สลิป</th><th className="p-3 text-center">สถานะ</th><th className="p-3 text-center">จัดการ</th></tr></thead>
                            <tbody className="divide-y">
                                {donations.map(d => (
                                    <tr key={d.id} className="hover:bg-gray-50">
                                        <td className="p-3">{new Date(d.dateTime).toLocaleDateString('th-TH')}</td>
                                        <td className="p-3"><div>{d.name}</div><div className="text-xs text-gray-500 truncate max-w-[200px]">{d.purpose}</div></td>
                                        <td className="p-3 text-right font-bold">{d.amount.toLocaleString()}</td>
                                        <td className="p-3 text-center">{d.slipImage ? <button onClick={()=>setViewSlip(d.slipImage)} className="text-blue-600"><ImageIcon className="w-4 h-4 mx-auto"/></button> : '-'}</td>
                                        <td className="p-3 text-center"><span className={`px-2 py-1 rounded-full text-xs ${d.status==='approved'?'bg-green-100 text-green-800':d.status==='pending'?'bg-yellow-100 text-yellow-800':'bg-red-100 text-red-800'}`}>{d.status}</span></td>
                                        <td className="p-3 text-center"><button onClick={()=>setEditing(d)} className="text-gray-400 hover:text-orange-600"><Pencil className="w-4 h-4"/></button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- APPROVAL PANEL ---
        function ApprovalPanel({ donations, onApprove, onReject }) {
            const pending = donations.filter(d => d.status === 'pending');
            const [viewSlip, setViewSlip] = useState(null);
            return (
                <div className="space-y-4">
                    {viewSlip && <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4" onClick={() => setViewSlip(null)}><img src={viewSlip} className="max-h-[90vh] rounded" /></div>}
                    <h2 className="text-xl font-bold flex items-center"><ShieldCheck className="mr-2"/> รายการรออนุมัติ ({pending.length})</h2>
                    {pending.length === 0 ? <div className="bg-white p-8 text-center rounded shadow text-gray-500">ไม่มีรายการค้าง</div> : 
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        {pending.map(d => (
                            <div key={d.id} className="bg-white rounded shadow border border-yellow-200 flex flex-col">
                                <div className="p-4 flex-grow">
                                    <div className="text-xs text-gray-500">{new Date(d.dateTime).toLocaleString('th-TH')}</div>
                                    <div className="font-bold text-lg">{d.name}</div>
                                    <div className="text-sm text-gray-600 my-2">{d.purpose}</div>
                                    <div className="text-xl font-bold text-orange-600">{d.amount.toLocaleString()} ฿</div>
                                    {d.slipImage && <button onClick={()=>setViewSlip(d.slipImage)} className="text-xs text-blue-600 mt-2 flex items-center"><ImageIcon className="w-3 h-3 mr-1"/>ดูสลิป</button>}
                                </div>
                                <div className="flex border-t bg-gray-50"><button onClick={()=>onApprove(d.id)} className="flex-1 py-3 text-green-700 font-bold border-r hover:bg-green-100">อนุมัติ</button><button onClick={()=>onReject(d.id)} className="flex-1 py-3 text-red-600 font-bold hover:bg-red-50">ปฏิเสธ</button></div>
                            </div>
                        ))}
                    </div>}
                </div>
            );
        }

        // --- ANNOUNCER PANEL ---
        function AnnouncerPanel({ donations, onUpdateStatus, settings }) {
            const waitingQueue = donations.filter(d => d.status === 'approved' && !d.announced).sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));
            const announcedHistory = donations.filter(d => d.announced).sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime));
            const current = waitingQueue[0];
            const theme = settings?.themeColor || 'orange';

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2">
                        <div className={`bg-white rounded-2xl shadow-lg border-2 border-${theme}-200 p-8 text-center min-h-[400px] flex flex-col justify-center`}>
                            {current ? (
                                <div className="animate-fade-in w-full">
                                    <div className="text-gray-500 mb-2">ลำดับต่อไป... (เวลา: {new Date(current.dateTime).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})})</div>
                                    <h1 className="text-5xl font-bold text-gray-900 mb-6">{current.name}</h1>
                                    <div className={`bg-${theme}-50 p-6 rounded-xl mb-8 text-left`}>
                                        <div className="text-lg text-gray-600 mb-2">รายการบริจาค:</div>
                                        <div className="text-2xl font-semibold">{current.purpose}</div>
                                        <div className={`text-4xl font-bold text-${theme}-600 text-right mt-4`}>{current.amount.toLocaleString()} บาท</div>
                                        {current.generalNote && <div className="mt-4 pt-4 border-t text-xl italic text-gray-700">"{current.generalNote}"</div>}
                                    </div>
                                    <button onClick={()=>onUpdateStatus(current.id, true)} className={`bg-${theme}-600 text-white text-2xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition`}>ประกาศแล้ว</button>
                                </div>
                            ) : <div className="text-gray-400"><CheckCircle className="w-20 h-20 mx-auto mb-4 opacity-50"/><h3 className="text-3xl font-bold">ประกาศครบแล้ว</h3></div>}
                        </div>
                    </div>
                    <div className="space-y-4">
                        <div className="bg-white rounded shadow p-4 max-h-[300px] overflow-y-auto"><h3 className="font-bold border-b pb-2 mb-2 sticky top-0 bg-white">คิวถัดไป ({Math.max(0, waitingQueue.length-1)})</h3><ul>{waitingQueue.slice(1).map(d=><li key={d.id} className="py-2 border-b flex justify-between"><span>{d.name}</span><span className={`text-${theme}-600 font-bold`}>{d.amount}</span></li>)}</ul></div>
                        <div className="bg-white rounded shadow p-4 max-h-[300px] overflow-y-auto"><h3 className="font-bold border-b pb-2 mb-2 sticky top-0 bg-white">ประกาศแล้ว</h3><ul>{announcedHistory.map(d=><li key={d.id} className="py-2 border-b flex justify-between items-center group"><span>{d.name}</span><button onClick={()=>onUpdateStatus(d.id, false)} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500"><RotateCcw className="w-4 h-4"/></button></li>)}</ul></div>
                    </div>
                </div>
            );
        }

        // --- ADMIN SETTINGS PANEL ---
        function AdminSettingsPanel({ settings, onSave, onClearData }) {
            const [config, setConfig] = useState(settings);
            const [confirmClear, setConfirmClear] = useState('');
            const [showClearModal, setShowClearModal] = useState(false);
            const [activeSection, setActiveSection] = useState('general');

            useEffect(() => setConfig(settings), [settings]);
            
            const handleAddType = () => setConfig({...config, donationTypes: [...config.donationTypes, { id: `t_${Date.now()}`, name: 'ใหม่', hasQuantity: false, price: 0, active: true }]});
            const handleUpdateType = (idx, field, val) => { const newTypes = [...config.donationTypes]; newTypes[idx][field] = val; setConfig({...config, donationTypes: newTypes}); };
            const handleRemoveType = (idx) => { const newTypes = [...config.donationTypes]; newTypes.splice(idx, 1); setConfig({...config, donationTypes: newTypes}); };
            const themeColors = [{id:'orange',class:'bg-orange-500'},{id:'yellow',class:'bg-yellow-500'},{id:'red',class:'bg-red-600'},{id:'emerald',class:'bg-emerald-600'},{id:'blue',class:'bg-blue-600'},{id:'stone',class:'bg-stone-500'}];

            return (
                <div className="bg-white p-6 rounded shadow space-y-6">
                    <h2 className="text-2xl font-bold flex items-center"><Settings className="mr-2"/> ตั้งค่าระบบ</h2>
                    <div className="flex space-x-2 border-b overflow-x-auto">
                        {['general','donation','contact','security'].map(s=><button key={s} onClick={()=>setActiveSection(s)} className={`px-4 py-2 capitalize ${activeSection===s?'border-b-2 border-blue-500 text-blue-600':''}`}>{s}</button>)}
                    </div>
                    
                    <div className="bg-white p-6 rounded border">
                        {activeSection === 'general' && (
                            <div className="grid md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="font-bold mb-2">สถานะ</h3>
                                    <div className="flex gap-2 mb-4">{['open','closed','maintenance'].map(s=><button key={s} onClick={()=>setConfig({...config, systemStatus:s})} className={`px-3 py-2 border rounded ${config.systemStatus===s?'bg-gray-800 text-white':''}`}>{s}</button>)}</div>
                                    <h3 className="font-bold mb-2">ธีม & ฟอนต์</h3>
                                    <div className="flex gap-2 mb-4">{themeColors.map(c=><button key={c.id} onClick={()=>setConfig({...config, themeColor:c.id})} className={`w-8 h-8 rounded-full ${c.class} ${config.themeColor===c.id?'ring-2 ring-gray-400':''}`}></button>)}</div>
                                    <select className="w-full border p-2 rounded mb-2" value={config.fontFamily} onChange={e=>setConfig({...config, fontFamily:e.target.value})}>{FONT_OPTIONS.map(f=><option key={f.id} value={f.id}>{f.name}</option>)}</select>
                                </div>
                                <div><h3 className="font-bold mb-2">ข้อมูลวัด</h3><input className="w-full border p-2 rounded mb-2" value={config.templeName} onChange={e=>setConfig({...config, templeName:e.target.value})} placeholder="ชื่อวัด"/><input className="w-full border p-2 rounded" value={config.bannerUrl} onChange={e=>setConfig({...config, bannerUrl:e.target.value})} placeholder="Banner URL"/></div>
                            </div>
                        )}
                        {activeSection === 'donation' && (
                            <div className="grid md:grid-cols-2 gap-6">
                                <div className="space-y-2">
                                    <h3 className="font-bold">บัญชีรับเงิน</h3>
                                    <input className="w-full border p-2 rounded" value={config.bankInfo?.bankName} onChange={e=>setConfig({...config, bankInfo:{...config.bankInfo, bankName:e.target.value}})} placeholder="ธนาคาร"/>
                                    <input className="w-full border p-2 rounded" value={config.bankInfo?.accountNumber} onChange={e=>setConfig({...config, bankInfo:{...config.bankInfo, accountNumber:e.target.value}})} placeholder="เลขบัญชี"/>
                                    <input className="w-full border p-2 rounded" value={config.qrCodeUrl} onChange={e=>setConfig({...config, qrCodeUrl:e.target.value})} placeholder="QR Code URL"/>
                                    <label className="flex items-center mt-2"><input type="checkbox" checked={config.requireSlip} onChange={e=>setConfig({...config, requireSlip:e.target.checked})} className="mr-2"/>ต้องแนบสลิป</label>
                                </div>
                                <div>
                                    <div className="flex justify-between mb-2"><h3 className="font-bold">ประเภทการบริจาค</h3><button onClick={handleAddType} className="text-blue-600 text-sm">+ เพิ่ม</button></div>
                                    <div className="space-y-2 max-h-60 overflow-y-auto">
                                        {config.donationTypes.map((t,i)=>(<div key={i} className="flex gap-2 text-sm items-center"><input className="border p-1 flex-grow" value={t.name} onChange={e=>handleUpdateType(i,'name',e.target.value)} disabled={t.isSpecial}/><label><input type="checkbox" checked={t.hasQuantity} onChange={e=>handleUpdateType(i,'hasQuantity',e.target.checked)} disabled={t.isSpecial}/>มีจำนวน</label><input type="number" className="border p-1 w-16" value={t.price} onChange={e=>handleUpdateType(i,'price',e.target.value)} disabled={!t.hasQuantity}/><button onClick={()=>handleRemoveType(i)} disabled={t.isSpecial} className="text-red-500">ลบ</button></div>))}
                                    </div>
                                </div>
                            </div>
                        )}
                        {activeSection === 'contact' && <div className="space-y-2"><input className="w-full border p-2 rounded" value={config.contact?.phone} onChange={e=>setConfig({...config, contact:{...config.contact, phone:e.target.value}})} placeholder="เบอร์โทร"/><textarea className="w-full border p-2 rounded" value={config.contact?.address} onChange={e=>setConfig({...config, contact:{...config.contact, address:e.target.value}})} placeholder="ที่อยู่"></textarea></div>}
                        {activeSection === 'security' && <div className="grid md:grid-cols-2 gap-4"><div><label>รหัส Staff</label><input className="w-full border p-2 rounded" value={config.passwords?.staff} onChange={e=>setConfig({...config, passwords:{...config.passwords, staff:e.target.value}})}/></div><div><label>รหัส Admin</label><input className="w-full border p-2 rounded" value={config.passwords?.admin} onChange={e=>setConfig({...config, passwords:{...config.passwords, admin:e.target.value}})}/></div></div>}
                    </div>

                    <div className="flex justify-end gap-4 pt-4 border-t">
                        <button onClick={()=>onSave(config)} className="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">บันทึกทั้งหมด</button>
                    </div>
                    <div className="border-t pt-4">
                        <h3 className="text-red-600 font-bold mb-2">ล้างข้อมูล (อันตราย)</h3>
                        <div className="flex gap-2"><input type="password" placeholder="รหัส Admin ยืนยัน" className="border p-2 rounded" value={confirmClear} onChange={e=>setConfirmClear(e.target.value)}/><button onClick={()=>{if(confirmClear===(config.passwords?.admin||'admin104')){onClearData();setConfirmClear('');}else alert('รหัสผิด');}} className="bg-red-100 text-red-600 px-4 py-2 rounded">ยืนยันลบ</button></div>
                    </div>
                </div>
            );
        }

        function LoginModal({ role, onClose, onLoginSuccess, settings }) {
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if((role==='staff'&&password===(settings.passwords?.staff||'104'))||(role==='admin'&&password===(settings.passwords?.admin||'admin104'))) onLoginSuccess(); else alert('รหัสผ่านไม่ถูกต้อง'); };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-xl shadow-lg max-w-sm w-full">
                        <h3 className="text-xl font-bold mb-4">เข้าสู่ระบบ ({role})</h3>
                        <form onSubmit={handleSubmit}>
                            <input type="password" className="w-full border p-2 rounded mb-4" value={password} onChange={e=>setPassword(e.target.value)} autoFocus />
                            <button className="w-full bg-blue-600 text-white py-2 rounded font-bold">ยืนยัน</button>
                            <button type="button" onClick={onClose} className="w-full mt-2 text-gray-500">ยกเลิก</button>
                        </form>
                    </div>
                </div>
            );
        }

        function EditModal({ donation, userRole, onClose, onSave }) {
            const [data, setData] = useState({...donation});
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white p-6 rounded-xl shadow-lg max-w-md w-full">
                        <h3 className="font-bold mb-4">แก้ไขข้อมูล</h3>
                        <input className="w-full border p-2 rounded mb-2" value={data.name} onChange={e=>setData({...data, name:e.target.value})} />
                        <input className="w-full border p-2 rounded mb-2" type="number" value={data.amount} onChange={e=>setData({...data, amount:Number(e.target.value)})} />
                        <select className="w-full border p-2 rounded mb-4" value={data.status} onChange={e=>setData({...data, status:e.target.value})}><option value="pending">รอตรวจสอบ</option><option value="approved">อนุมัติ</option><option value="rejected">ปฏิเสธ</option></select>
                        <div className="flex gap-2"><button onClick={()=>onSave(data)} className="flex-1 bg-blue-600 text-white py-2 rounded">บันทึก</button><button onClick={onClose} className="flex-1 bg-gray-200 py-2 rounded">ยกเลิก</button></div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
