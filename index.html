<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>วัดไชยามาตย์ - ระบบรับบริจาคออนไลน์</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Sarabun', 'sans-serif'] },
                    colors: { temple: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c', 700: '#c2410c', 800: '#9a3412', 900: '#7c2d12' } }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-container { width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, createContext, useContext } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Home, PlusCircle, ClipboardList, CheckCircle, User, ShieldCheck, Filter, X, ArrowLeft, 
            HeartHandshake, MapPin, Phone, Calendar, BookOpen, Menu, Download, Printer, Lock, LogOut, 
            FileText, Megaphone, Mic, RotateCcw, Pencil, Save, Key, UploadCloud, Image as ImageIcon, 
            Loader, Maximize2, Trash2, Edit, Plus, AlertTriangle, Settings, Power, RefreshCw, 
            AlertOctagon, Check, Search, Info, LayoutDashboard
        } from 'https://esm.sh/lucide-react@0.344.0';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, setDoc, doc, onSnapshot, query, deleteDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = { apiKey: "AIzaSyAHuvRRTNpYuh8MFiIwN4Lm106l09BED14", authDomain: "donation-1b152.firebaseapp.com", projectId: "donation-1b152", storageBucket: "donation-1b152.firebasestorage.app", messagingSenderId: "203853712269", appId: "1:203853712269:web:80441cd834e7b0e68dcbc4", measurementId: "G-10ZKFX0TET" };
        let app, auth, db, appId = 'temple-donation-app';
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Firebase Init Error:", e); }

        // --- Utilities ---
        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => {
                const canvas = document.createElement('canvas'); const MAX_WIDTH = 800; const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7));
            };};
        });

        // --- Toast System ---
        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (msg, type = 'success') => { const id = Date.now(); setToasts(p => [...p, { id, msg, type }]); setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 3000); };
            return <ToastContext.Provider value={addToast}>{children}<div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2">{toasts.map(t => <div key={t.id} className={`flex items-center px-4 py-3 rounded-lg shadow-lg text-white ${t.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>{t.msg}</div>)}</div></ToastContext.Provider>;
        };
        const useToast = () => useContext(ToastContext);

        // --- 1. GLOBAL COMPONENTS (Declared outside to prevent ReferenceError) ---

        const PermissionErrorScreen = ({ onUseDemo }) => (
            <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-4">
                <div className="bg-white p-8 rounded-xl shadow-xl max-w-lg w-full text-center border-t-4 border-red-500">
                    <AlertTriangle className="w-16 h-16 text-red-500 mx-auto mb-4" />
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">สิทธิ์การเข้าถึงฐานข้อมูลไม่ถูกต้อง</h2>
                    <p className="text-gray-600 mb-4">กรุณาตั้งค่า <strong>Firestore Rules</strong> ใน Firebase Console</p>
                    <div className="flex gap-3 justify-center">
                        <button onClick={() => window.location.reload()} className="bg-blue-600 text-white px-6 py-2 rounded-lg">ลองใหม่</button>
                        <button onClick={onUseDemo} className="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg">เข้าโหมดสาธิต</button>
                    </div>
                </div>
            </div>
        );

        const LoginModal = ({ role, onClose, onLoginSuccess }) => {
            const [password, setPassword] = useState(''); const [error, setError] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); 
                let targetRole = role;
                if (!targetRole) { if (password === '104') targetRole = 'staff'; else if (password === 'admin104') targetRole = 'admin'; }
                if ((targetRole === 'staff' && password === '104') || (targetRole === 'admin' && password === 'admin104')) onLoginSuccess(targetRole);
                else setError('รหัสผ่านไม่ถูกต้อง'); 
            };
            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 animate-scale-up">
                        <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Lock className="w-5 h-5 text-temple-600"/> {role ? `เข้าสู่ระบบ (${role})` : 'เข้าสู่ระบบเจ้าหน้าที่'}</h3><button onClick={onClose}><X className="w-5 h-5 text-gray-400"/></button></div>
                        <form onSubmit={handleSubmit}><div className="mb-6"><input type="password" className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-temple-500" placeholder="กรุณากรอกรหัสผ่าน..." value={password} onChange={(e) => setPassword(e.target.value)} autoFocus />{error && <p className="text-red-500 text-sm mt-2">{error}</p>}</div><button type="submit" className="w-full bg-temple-600 text-white font-bold py-3 rounded-xl shadow-lg">ยืนยัน</button></form>
                    </div>
                </div>
            );
        };

        const DonationForm = ({ userRole, onSave, systemConfig }) => {
            const [form, setForm] = useState({ name: '', method: 'เงินโอน', note: '', slip: null });
            const [items, setItems] = useState({ general: { checked: true, amount: '' }, thaiTaan: { checked: false, sets: 1 }, huaWat: { checked: false, sets: 1 }, roongTaan: { checked: false, date: '', note: '' } });
            const [isUploading, setIsUploading] = useState(false); const [showQR, setShowQR] = useState(false);
            const toast = useToast();
            const total = useMemo(() => { let sum = 0; if(items.general.checked) sum += Number(items.general.amount||0); if(items.thaiTaan.checked) sum += items.thaiTaan.sets*300; if(items.huaWat.checked) sum += items.huaWat.sets*500; return sum; }, [items]);
            
            const handleSubmit = (e) => { e.preventDefault();
                if(!form.name) return toast("ระบุชื่อ", "error"); if(total<=0 && !items.roongTaan.checked) return toast("ระบุยอด", "error"); if(form.method==='เงินโอน' && !form.slip && userRole==='donor') return toast("แนบสลิป", "error");
                let purpose = []; if(items.general.checked) purpose.push(`${systemConfig.eventName} ${Number(items.general.amount).toLocaleString()} บ.`); if(items.thaiTaan.checked) purpose.push(`ไทยทาน ${items.thaiTaan.sets} ชุด`); if(items.huaWat.checked) purpose.push(`หัววัด ${items.huaWat.sets} ชุด`); if(items.roongTaan.checked) purpose.push(`โรงทาน`);
                onSave({ dateTime: new Date().toISOString(), name: form.name, purpose: purpose.join(', '), amount: total, method: form.method, generalNote: form.note, status: userRole==='donor'?'pending':'approved', source: userRole==='donor'?'self':'staff', announced: false, slipImage: form.slip, roongTaanDate: items.roongTaan.checked?items.roongTaan.date:null });
                setForm({ name:'', method:'เงินโอน', note:'', slip:null }); toast(userRole==='donor'?"ส่งข้อมูลแล้ว":"บันทึกแล้ว");
            };
            const handleFile = async (e) => { if(e.target.files[0]){ setIsUploading(true); try{ setForm({...form, slip: await resizeImage(e.target.files[0])}); }catch{} setIsUploading(false); } };
            
            if(!systemConfig.isOnline && userRole === 'donor') return <div className="text-center p-12 bg-white rounded-2xl shadow-sm border border-gray-200"><Power className="w-16 h-16 mx-auto text-gray-300 mb-4"/><h3 className="text-xl font-bold text-gray-700">ปิดรับบริจาคออนไลน์ชั่วคราว</h3></div>;
            
            return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div className="bg-temple-50 px-6 py-4 border-b border-temple-100 flex justify-between items-center"><h2 className="font-bold text-temple-800 flex items-center"><HeartHandshake className="w-5 h-5 mr-2"/> {userRole==='donor'?'แจ้งความประสงค์':'บันทึกรับเงิน'}</h2></div>
                    <form onSubmit={handleSubmit} className="p-6 space-y-6">
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">ชื่อ-สกุล / คณะเจ้าภาพ</label><input type="text" required className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-temple-500" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} /></div>
                        <div className="space-y-3"><label className="block text-sm font-medium text-gray-700">เลือกรายการทำบุญ</label>
                            <div className={`p-3 rounded-lg border transition-all ${items.general.checked?'bg-temple-50 border-temple-300':'border-gray-200'}`}><div className="flex items-center"><input type="checkbox" className="w-5 h-5 text-temple-600 rounded" checked={items.general.checked} onChange={e=>setItems({...items, general:{...items.general, checked:e.target.checked}})} /><span className="ml-3 font-medium text-gray-800">{systemConfig.eventName}</span></div>{items.general.checked && <input type="number" placeholder="ยอดเงิน" className="mt-3 w-full p-2 bg-white border rounded" value={items.general.amount} onChange={e=>setItems({...items, general:{...items.general, amount:e.target.value}})} autoFocus />}</div>
                            <div className={`p-3 rounded-lg border transition-all ${items.thaiTaan.checked?'bg-temple-50 border-temple-300':'border-gray-200'}`}><div className="flex items-center justify-between"><div className="flex items-center"><input type="checkbox" className="w-5 h-5 text-temple-600 rounded" checked={items.thaiTaan.checked} onChange={e=>setItems({...items, thaiTaan:{...items.thaiTaan, checked:e.target.checked}})} /><span className="ml-3 font-medium text-gray-800">ไทยทาน (300.-)</span></div>{items.thaiTaan.checked && <div className="flex items-center gap-2 bg-white rounded-lg border px-2 py-1"><button type="button" onClick={()=>setItems(p=>({...p, thaiTaan:{...p.thaiTaan, sets:Math.max(1, p.thaiTaan.sets-1)}}))}>-</button><span className="w-8 text-center font-bold">{items.thaiTaan.sets}</span><button type="button" onClick={()=>setItems(p=>({...p, thaiTaan:{...p.thaiTaan, sets:p.thaiTaan.sets+1}}))}>+</button></div>}</div></div>
                            <div className={`p-3 rounded-lg border transition-all ${items.huaWat.checked?'bg-temple-50 border-temple-300':'border-gray-200'}`}><div className="flex items-center justify-between"><div className="flex items-center"><input type="checkbox" className="w-5 h-5 text-temple-600 rounded" checked={items.huaWat.checked} onChange={e=>setItems({...items, huaWat:{...items.huaWat, checked:e.target.checked}})} /><span className="ml-3 font-medium text-gray-800">หัววัด (500.-)</span></div>{items.huaWat.checked && <div className="flex items-center gap-2 bg-white rounded-lg border px-2 py-1"><button type="button" onClick={()=>setItems(p=>({...p, huaWat:{...p.huaWat, sets:Math.max(1, p.huaWat.sets-1)}}))}>-</button><span className="w-8 text-center font-bold">{items.huaWat.sets}</span><button type="button" onClick={()=>setItems(p=>({...p, huaWat:{...p.huaWat, sets:p.huaWat.sets+1}}))}>+</button></div>}</div></div>
                            <div className={`p-3 rounded-lg border transition-all ${items.roongTaan.checked?'bg-temple-50 border-temple-300':'border-gray-200'}`}><div className="flex items-center"><input type="checkbox" className="w-5 h-5 text-temple-600 rounded" checked={items.roongTaan.checked} onChange={e=>setItems({...items, roongTaan:{...items.roongTaan, checked:e.target.checked}})} /><span className="ml-3 font-medium text-gray-800">จองโรงทาน</span></div>{items.roongTaan.checked && <div className="mt-3 space-y-2"><input type="date" className="w-full p-2 bg-white border rounded" value={items.roongTaan.date} onChange={e=>setItems({...items, roongTaan:{...items.roongTaan, date:e.target.value}})} /><input type="text" placeholder="สิ่งของ" className="w-full p-2 bg-white border rounded" value={items.roongTaan.note} onChange={e=>setItems({...items, roongTaan:{...items.roongTaan, note:e.target.value}})} /></div>}</div>
                        </div>
                        <div className="flex justify-between items-center bg-gray-50 p-4 rounded-xl border border-gray-200"><span className="text-gray-600">ยอดรวมทั้งสิ้น</span><span className="text-2xl font-bold text-temple-600">{total.toLocaleString()} บาท</span></div>
                        <div><label className="block text-sm font-medium text-gray-700 mb-2">ช่องทางชำระเงิน</label><div className="grid grid-cols-3 gap-2">{['เงินโอน', 'เงินสด', 'อื่นๆ'].map(m=><button key={m} type="button" onClick={()=>setForm({...form, method:m})} className={`py-2 rounded-lg text-sm border ${form.method===m?'bg-temple-600 text-white':'bg-white text-gray-600'}`}>{m}</button>)}</div></div>
                        {form.method === 'เงินโอน' && (<div className="bg-gray-50 border border-gray-200 rounded-xl p-4 text-center">{userRole==='donor'&&(<div className="mb-4"><div className="bg-white p-2 rounded-lg shadow-sm inline-block cursor-pointer" onClick={()=>setShowQR(true)}><img src="https://img2.pic.in.th/pic/099400240646898.png" className="w-32 h-32 object-contain" /></div><div className="flex justify-center gap-2 mt-2"><button type="button" onClick={()=>setShowQR(true)} className="text-xs text-blue-600 hover:underline flex items-center"><Maximize2 className="w-3 h-3 mr-1"/> ขยาย</button></div></div>)}<label className="block w-full border-2 border-dashed border-gray-300 rounded-lg p-4 cursor-pointer hover:bg-white transition bg-white"><div className="flex flex-col items-center">{isUploading?<Loader className="w-6 h-6 animate-spin"/>:<UploadCloud className="w-6 h-6"/>}<span className="text-sm text-gray-500">{form.slip?'เปลี่ยนรูป':'แนบสลิป'}</span></div><input type="file" accept="image/*" className="hidden" onChange={handleFile}/></label>{form.slip && <div className="mt-2 relative inline-block"><img src={form.slip} className="h-24 rounded border"/><button type="button" onClick={()=>setForm({...form, slip:null})} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1"><X className="w-3 h-3"/></button></div>}</div>)}
                        <div><label className="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label><textarea rows="2" className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg" value={form.note} onChange={e=>setForm({...form, note:e.target.value})}></textarea></div>
                        <div className="flex gap-3 pt-2"><button type="button" onClick={()=>{if(confirm('ล้างข้อมูล?')) setForm({name:'',method:'เงินโอน',note:'',slip:null});}} className="px-4 py-3 bg-gray-100 text-gray-600 rounded-xl"><RefreshCw/></button><button type="submit" disabled={isUploading} className="flex-1 font-bold text-white py-3 rounded-xl bg-temple-600 hover:bg-temple-700 shadow-lg">{isUploading?'กำลังอัปโหลด...':'ยืนยันการทำบุญ'}</button></div>
                    </form>
                    {showQR && <div className="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4" onClick={()=>setShowQR(false)}><img src="https://img2.pic.in.th/pic/099400240646898.png" className="max-w-full max-h-[80vh] rounded-lg shadow-2xl"/><button className="absolute top-4 right-4 text-white"><X className="w-8 h-8"/></button></div>}
                </div>
            );
        };

        const EditModal = ({ donation, userRole, onClose, onSave }) => {
            const [formData, setFormData] = useState({ ...donation }); const [securityCode, setSecurityCode] = useState(''); const [error, setError] = useState('');
            const handleSave = () => {
                if (!formData.name || !formData.amount) return setError('ข้อมูลไม่ครบ');
                if (userRole === 'staff' && securityCode !== '104') return setError('รหัสผิด');
                onSave(formData); onClose();
            };
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-lg p-6 animate-scale-up"><div className="flex justify-between items-center mb-6 border-b pb-2"><h3 className="text-xl font-bold">แก้ไข</h3><button onClick={onClose}><X/></button></div>
                <div className="space-y-4">
                    <input className="w-full p-2 border rounded" value={formData.name} onChange={e=>setFormData({...formData, name:e.target.value})} placeholder="ชื่อ" />
                    <input className="w-full p-2 border rounded" value={formData.purpose} onChange={e=>setFormData({...formData, purpose:e.target.value})} placeholder="รายการ" />
                    <div className="flex gap-4"><input type="number" className="w-1/2 p-2 border rounded" value={formData.amount} onChange={e=>setFormData({...formData, amount:Number(e.target.value)})} /><select className="w-1/2 p-2 border rounded" value={formData.status} onChange={e=>setFormData({...formData, status:e.target.value})}><option value="pending">รอตรวจ</option><option value="approved">อนุมัติ</option><option value="rejected">ปฏิเสธ</option></select></div>
                    {userRole==='staff' && <input type="password" placeholder="รหัสเจ้าหน้าที่ (104)" className="w-full p-2 border border-red-200 rounded bg-red-50" value={securityCode} onChange={e=>setSecurityCode(e.target.value)} />}
                    {error && <div className="text-red-500 text-sm">{error}</div>}
                    <button onClick={handleSave} className="w-full py-2 bg-temple-600 text-white rounded shadow">บันทึก</button>
                </div></div></div>
            );
        };

        const Dashboard = ({ donations, userRole, onUpdateDonation }) => {
            const [edit, setEdit] = useState(null); const [viewSlip, setViewSlip] = useState(null); const [filter, setFilter] = useState('');
            const filteredList = useMemo(() => donations.filter(d => (userRole!=='donor' || d.status==='approved') && (d.name.includes(filter) || d.purpose.includes(filter))), [donations, userRole, filter]);
            const total = filteredList.reduce((s,d) => d.status==='approved'?s+d.amount:s, 0);
            const exportCSV = () => {
                const csv = "data:text/csv;charset=utf-8,\uFEFF" + ["Date,Name,Purpose,Amount,Status"].join(',') + '\n' + filteredList.map(d=>[new Date(d.dateTime).toLocaleDateString(), `"${d.name}"`, `"${d.purpose}"`, d.amount, d.status].join(',')).join('\n');
                const link = document.createElement("a"); link.href = encodeURI(csv); link.download="donations.csv"; link.click();
            };
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100"><div><p className="text-gray-500 text-sm">ยอดเงินรวม</p><h3 className="text-2xl font-bold text-green-600">{total.toLocaleString()} ฿</h3></div></div></div>
                    <div className="flex justify-between no-print"><input type="text" placeholder="ค้นหา..." className="p-2 border rounded" value={filter} onChange={e=>setFilter(e.target.value)} /><button onClick={exportCSV} className="bg-green-600 text-white px-4 py-2 rounded">Export CSV</button></div>
                    <div className="bg-white rounded-xl shadow-sm overflow-hidden print-container"><div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-gray-50 text-gray-600"><tr><th className="p-4">วันที่</th><th className="p-4">ผู้บริจาค</th><th className="p-4">รายการ</th><th className="p-4 text-right">ยอดเงิน</th><th className="p-4 text-center">สถานะ</th><th className="p-4 no-print"></th></tr></thead><tbody className="divide-y divide-gray-100">{filteredList.map(d=><tr key={d.id} className="hover:bg-gray-50"><td className="p-4">{new Date(d.dateTime).toLocaleDateString('th-TH')}</td><td className="p-4">{d.name}</td><td className="p-4 max-w-xs truncate">{d.purpose}</td><td className="p-4 text-right">{d.amount.toLocaleString()}</td><td className="p-4 text-center"><span className={`px-2 py-1 rounded text-xs ${d.status==='approved'?'bg-green-100':'bg-yellow-100'}`}>{d.status}</span></td><td className="p-4 no-print">{userRole!=='donor'&&<button onClick={()=>setEdit(d)}><Pencil className="w-4 h-4 text-gray-500"/></button>}</td></tr>)}</tbody></table></div></div>
                    {edit && <EditModal donation={edit} userRole={userRole} onClose={()=>setEdit(null)} onSave={onUpdateDonation}/>}
                    {viewSlip && <div className="fixed inset-0 bg-black/90 z-[100] flex justify-center p-4" onClick={()=>setViewSlip(null)}><img src={viewSlip} className="max-h-[90vh] rounded"/></div>}
                </div>
            );
        };

        const ApprovalPanel = ({ donations, onApprove, onReject }) => {
            const pending = donations.filter(d => d.status === 'pending'); const [viewSlip, setViewSlip] = useState(null);
            return (
                <div className="space-y-4">
                    <h2 className="text-xl font-bold flex items-center"><ShieldCheck className="w-6 h-6 mr-2 text-temple-600"/> รอตรวจสอบ ({pending.length})</h2>
                    {pending.length===0 ? <div className="text-center py-10 bg-white rounded shadow-sm">ไม่มีรายการค้าง</div> : <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">{pending.map(d=><div key={d.id} className="bg-white rounded-xl shadow-sm p-4 border border-gray-100"><div className="flex justify-between items-start mb-2"><div><div className="text-xs text-gray-400">{new Date(d.dateTime).toLocaleString('th-TH')}</div><h3 className="font-bold text-lg">{d.name}</h3></div>{d.slipImage && <button onClick={()=>setViewSlip(d.slipImage)} className="text-blue-500"><ImageIcon className="w-5 h-5"/></button>}</div><div className="text-sm text-gray-600 mb-2">{d.purpose}</div><div className="font-bold text-temple-600 text-lg mb-3">{d.amount.toLocaleString()} ฿</div><div className="flex gap-2"><button onClick={()=>onApprove(d.id)} className="flex-1 bg-green-500 text-white py-1 rounded">อนุมัติ</button><button onClick={()=>onReject(d.id)} className="flex-1 bg-white border border-red-200 text-red-500 py-1 rounded">ปฏิเสธ</button></div></div>)}</div>}
                    {viewSlip && <div className="fixed inset-0 bg-black/90 z-[100] flex justify-center p-4" onClick={()=>setViewSlip(null)}><img src={viewSlip} className="max-h-[90vh] rounded"/></div>}
                </div>
            );
        };

        const AnnouncerPanel = ({ donations, onUpdateStatus }) => {
            const queue = useMemo(() => donations.filter(d => d.status === 'approved' && !d.announced), [donations]);
            const history = useMemo(() => donations.filter(d => d.announced).sort((a,b)=> new Date(b.dateTime) - new Date(a.dateTime)).slice(0, 5), [donations]);
            const current = queue[0];
            const toast = useToast();
            return (
                <div className="grid lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2 bg-white rounded-2xl shadow-lg border-2 border-temple-100 p-8 text-center flex flex-col justify-center min-h-[300px]">
                        {current ? <div className="animate-scale-up"><div className="inline-block bg-temple-100 text-temple-800 px-4 py-1 rounded-full text-sm font-bold mb-6">ลำดับถัดไป</div><h1 className="text-5xl font-bold mb-4">{current.name}</h1><div className="text-4xl text-temple-600 font-bold mb-6">{current.amount.toLocaleString()} บาท</div><p className="text-xl text-gray-600 mb-6">{current.purpose}</p><button onClick={()=>{onUpdateStatus(current.id, true); toast(`ประกาศคุณ ${current.name} แล้ว`)}} className="bg-green-600 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg">ประกาศแล้ว</button></div> : <div className="text-gray-400"><h3>ครบทุกรายการแล้ว</h3></div>}
                    </div>
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4"><h3 className="font-bold border-b pb-2 mb-2">ประวัติประกาศ</h3>{history.map(d=><div key={d.id} className="flex justify-between py-2 border-b text-sm"><span>{d.name}</span><button onClick={()=>onUpdateStatus(d.id, false)}><RotateCcw className="w-4 h-4 text-gray-400"/></button></div>)}</div>
                </div>
            );
        };

        const SettingsPanel = ({ config, onSave, onResetDatabase }) => {
            const [data, setData] = useState(config);
            const confirmReset = () => { if(confirm('ต้องการล้างข้อมูลทั้งหมด?')) if(confirm('ยืนยันครั้งสุดท้าย?')) onResetDatabase(); };
            return (
                <div className="max-w-2xl mx-auto bg-white rounded-xl shadow-md p-6 space-y-6">
                    <h2 className="text-xl font-bold flex items-center"><Settings className="w-6 h-6 mr-2"/> ตั้งค่าระบบ</h2>
                    <div><label className="block text-sm font-bold mb-2">ชื่องานบุญปัจจุบัน</label><input type="text" className="w-full p-3 border rounded-lg" value={data.eventName} onChange={e=>setData({...data, eventName:e.target.value})} /></div>
                    <div className="flex justify-between items-center bg-orange-50 p-4 rounded-lg"><span>เปิดรับบริจาคออนไลน์</span><input type="checkbox" checked={data.isOnline} onChange={e=>setData({...data, isOnline:e.target.checked})} className="w-5 h-5 custom-checkbox"/></div>
                    <button onClick={()=>onSave(data)} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg">บันทึก</button>
                    <div className="border-t pt-4"><button onClick={confirmReset} className="text-red-600 border border-red-300 px-4 py-2 rounded-lg text-sm font-bold w-full">ล้างข้อมูลทั้งหมด</button></div>
                </div>
            );
        };

        // --- Layouts ---

        const OfficialWebsite = ({ onNavigate, donations, userRole, setUserRole, user }) => {
            const total = useMemo(() => donations.filter(d => d.status === 'approved').reduce((sum, d) => sum + d.amount, 0), [donations]);
            const [showLogin, setShowLogin] = useState(false);
            const [isScrolled, setIsScrolled] = useState(false);
            const toast = useToast();
            useEffect(() => { const onScroll = () => setIsScrolled(window.scrollY > 20); window.addEventListener('scroll', onScroll); return () => window.removeEventListener('scroll', onScroll); }, []);

            return (
                <div className="min-h-screen bg-white font-sans">
                    <nav className={`fixed w-full z-50 transition-all duration-300 ${isScrolled ? 'bg-white/95 backdrop-blur-md shadow-md py-2' : 'bg-transparent py-4'}`}>
                        <div className="max-w-7xl mx-auto px-4 flex justify-between items-center">
                            <div className="flex items-center gap-2"><BookOpen className="text-orange-600"/> <span className={`font-bold text-lg ${isScrolled?'text-gray-800':'text-white'}`}>วัดไชยามาตย์</span></div>
                            <div className="flex gap-2">
                                <button onClick={() => onNavigate('donate-system')} className="bg-orange-600 text-white px-4 py-2 rounded-full font-bold shadow-lg hover:bg-orange-700 transition">ร่วมทำบุญ</button>
                                {userRole === 'donor' ? <button onClick={() => setShowLogin(true)} className={`p-2 rounded-full ${isScrolled?'text-gray-500':'text-white'}`}><Lock className="w-5 h-5"/></button> : <button onClick={() => {if(confirm('ออก?')) setUserRole('donor')}} className="p-2 text-red-500 bg-white rounded-lg"><LogOut className="w-5 h-5"/></button>}
                            </div>
                        </div>
                    </nav>
                    <header id="หน้าหลัก" className="relative h-[85vh] flex items-center justify-center bg-gray-900 overflow-hidden"><img src="https://img2.pic.in.th/IMG_2659.jpg" className="absolute inset-0 w-full h-full object-cover opacity-60 animate-scale-up" /><div className="relative z-10 text-center text-white px-4"><h1 className="text-5xl font-bold mb-4 drop-shadow-lg">วัดไชยามาตย์</h1><div className="backdrop-blur-md bg-white/20 border border-white/30 rounded-2xl p-4 inline-block mb-6"><p className="text-sm uppercase tracking-widest">ยอดบริจาครวม</p><div className="text-4xl font-bold">{total.toLocaleString()} ฿</div></div><br/><button onClick={() => onNavigate('donate-system')} className="bg-white text-orange-600 px-8 py-3 rounded-full font-bold shadow-xl">ร่วมบริจาคออนไลน์</button></div></header>
                    <NewsSection userRole={userRole} user={user} demoMode={!user} localNews={[]} setLocalNews={()=>{}} />
                    <footer className="bg-gray-900 text-white py-12 text-center text-sm"><p>&copy; วัดไชยามาตย์</p></footer>
                    {showLogin && <LoginModal onClose={()=>setShowLogin(false)} onLoginSuccess={(role)=>{setUserRole(role); setShowLogin(false); toast(`เข้าสู่ระบบ ${role}`);}} />}
                </div>
            );
        };

        const DonationSystem = ({ onBack, donations, onAdd, onUpdate, userRole, setUserRole, systemConfig, onUpdateConfig, onResetDatabase }) => {
            const [activeTab, setActiveTab] = useState('donate');
            const [showLogin, setShowLogin] = useState(false);
            const [pendingRole, setPendingRole] = useState(null);
            const toast = useToast();
            const handleRoleChange = (e) => { const role = e.target.value; if(role === 'donor') { setUserRole('donor'); setActiveTab('donate'); } else { setPendingRole(role); setShowLogin(true); } };
            return (
                <div className="min-h-screen bg-gray-50 pb-20 font-sans">
                    <header className="bg-white shadow-sm sticky top-0 z-30 border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-3"><button onClick={onBack}><ArrowLeft className="w-5 h-5 text-gray-600"/></button><h1 className="font-bold text-lg text-gray-800">ระบบจัดการวัด</h1></div>
                            <div className="flex items-center bg-gray-100 rounded-lg px-3 py-1.5 border border-gray-200"><User className="w-4 h-4 mr-2 text-gray-500"/><select className="bg-transparent outline-none text-sm text-gray-700 font-medium cursor-pointer" value={userRole} onChange={handleRoleChange}><option value="donor">ผู้บริจาค (ทั่วไป)</option><option value="staff">เจ้าหน้าที่ (Staff)</option><option value="admin">ผู้ดูแล (Admin)</option></select></div>
                        </div>
                        <div className="max-w-7xl mx-auto px-4 flex gap-6 overflow-x-auto hide-scrollbar border-t border-gray-100 pt-1">
                            {[{id:'donate',label:'บริจาค',role:'all'},{id:'dashboard',label:'สรุปยอด',role:'staff'},{id:'announcer',label:'โฆษก',role:'staff'},{id:'approval',label:'อนุมัติ',role:'admin'},{id:'settings',label:'ตั้งค่า',role:'admin'}].filter(t=>t.role==='all'||userRole!=='donor').map(t=><button key={t.id} onClick={()=>setActiveTab(t.id)} className={`py-3 border-b-2 text-sm font-medium ${activeTab===t.id?'border-temple-600 text-temple-600':'border-transparent text-gray-500'}`}>{t.label}</button>)}
                        </div>
                    </header>
                    <main className="max-w-5xl mx-auto p-4 md:p-6 fade-in">
                        {activeTab === 'donate' && <DonationForm userRole={userRole} onSave={onAdd} systemConfig={systemConfig} />}
                        {activeTab === 'dashboard' && <Dashboard donations={donations} userRole={userRole} onUpdateDonation={onUpdate} />}
                        {activeTab === 'announcer' && <AnnouncerPanel donations={donations} onUpdateStatus={(id, status) => { const item = donations.find(d=>d.id===id); if(item) onUpdate({...item, announced: status}); }} />}
                        {activeTab === 'approval' && <ApprovalPanel donations={donations} onApprove={(id)=>{const item=donations.find(d=>d.id===id);if(item)onUpdate({...item, status:'approved'})}} onReject={(id)=>{const item=donations.find(d=>d.id===id);if(item)onUpdate({...item, status:'rejected'})}} />}
                        {activeTab === 'settings' && <SettingsPanel config={systemConfig} onSave={onUpdateConfig} onResetDatabase={onResetDatabase} />}
                    </main>
                    {showLogin && <LoginModal role={pendingRole} onClose={()=>setShowLogin(false)} onLoginSuccess={(role)=>{setUserRole(role); setShowLogin(false); toast(`เข้าสู่ระบบ ${role}`);}} />}
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [page, setPage] = useState('home');
            const [user, setUser] = useState(null);
            const [donations, setDonations] = useState([]);
            const [userRole, setUserRole] = useState('donor');
            const [systemConfig, setSystemConfig] = useState({ eventName: 'บริจาคทั่วไป', isOnline: true });
            const [permissionError, setPermissionError] = useState(false);
            const [demoMode, setDemoMode] = useState(false);
            const [localNews, setLocalNews] = useState([]);

            useEffect(() => { signInAnonymously(auth).catch(e => { console.error(e); setDemoMode(true); }); onAuthStateChanged(auth, u => { setUser(u); if(!u) setDemoMode(true); }); }, []);

            useEffect(() => {
                if (demoMode || !user) return;
                const unsub1 = onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'donations')), s => {
                    setDonations(s.docs.map(d => ({id:d.id,...d.data()})).sort((a,b)=>new Date(b.dateTime)-new Date(a.dateTime))); setPermissionError(false);
                }, e => { if(e.code==='permission-denied') setPermissionError(true); });
                const unsub2 = onSnapshot(doc(db, 'artifacts', appId, 'settings', 'config'), s => { if(s.exists()) setSystemConfig(s.data()); });
                return () => { unsub1(); unsub2(); };
            }, [user, demoMode]);

            const handleAdd = async (d) => { if(demoMode) { setDonations([d,...donations]); return; } await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'donations'), d); };
            const handleUpdate = async (d) => { if(demoMode) { setDonations(donations.map(x=>x.id===d.id?d:x)); return; } const {id,...data}=d; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'donations', id), data); };
            const handleConfig = async (c) => { if(demoMode) { setSystemConfig(c); return; } await setDoc(doc(db, 'artifacts', appId, 'settings', 'config'), c); };
            const handleReset = async () => { if(demoMode) { setDonations([]); return; } const s = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'donations')); s.forEach(d => deleteDoc(d.ref)); alert("ล้างข้อมูลเรียบร้อย"); };

            if (permissionError) return <PermissionErrorScreen onUseDemo={() => { setPermissionError(false); setDemoMode(true); }} />;

            return (
                <ToastProvider>
                    {page === 'home' ? (
                        <OfficialWebsite onNavigate={setPage} donations={donations} userRole={userRole} setUserRole={setUserRole} user={user} />
                    ) : (
                        <DonationSystem onBack={() => setPage('home')} donations={donations} onAdd={handleAdd} onUpdate={handleUpdate} userRole={userRole} setUserRole={setUserRole} systemConfig={systemConfig} onUpdateConfig={handleConfig} onResetDatabase={handleReset} />
                    )}
                </ToastProvider>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
