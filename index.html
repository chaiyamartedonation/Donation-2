<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>วัดไชยามาตย์ - ระบบรับบริจาคดิจิทัล</title>

<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body { font-family: 'Sarabun', sans-serif; background:#f8fafc; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-type="module">

import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* ================= Firebase ================= */

const firebaseConfig = {
  apiKey: "AIzaSyAHuvRRTNpYuh8MFiIwN4Lm106l09BED14",
  authDomain: "donation-1b152.firebaseapp.com",
  projectId: "donation-1b152",
  storageBucket: "donation-1b152.firebasestorage.app",
  messagingSenderId: "203853712269",
  appId: "1:203853712269:web:80441cd834e7b0e68dcbc4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= App ================= */

function App() {

  const [page, setPage] = useState('home');
  const [user, setUser] = useState(null);
  const [userRole, setUserRole] = useState('donor');
  const [donations, setDonations] = useState([]);
  const [systemConfig, setSystemConfig] = useState({
    eventName: "บริจาคทั่วไป",
    isOnline: true
  });

  /* ===== Auth ===== */
  useEffect(() => {
    signInAnonymously(auth);
    onAuthStateChanged(auth, (u)=> setUser(u));
  }, []);

  /* ===== Realtime Donations ===== */
  useEffect(() => {
    const q = query(collection(db, "donations"), orderBy("dateTime", "desc"));
    const unsub = onSnapshot(q, (snap)=>{
      const data = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      setDonations(data);
    });
    return ()=>unsub();
  }, []);

  /* ===== Add Donation ===== */
  const addDonation = async (data) => {
    await addDoc(collection(db,"donations"), data);
  };

  /* ===== Update Donation ===== */
  const updateDonation = async (data) => {
    const { id, ...rest } = data;
    await updateDoc(doc(db,"donations",id), rest);
  };

  return (
    <>
      {page === 'home' ? (
        <OfficialWebsite
          donations={donations}
          onNavigate={setPage}
          userRole={userRole}
          setUserRole={setUserRole}
        />
      ) : (
        <DonationSystem
          donations={donations}
          onBack={()=>setPage('home')}
          onAdd={addDonation}
          onUpdate={updateDonation}
          userRole={userRole}
          setUserRole={setUserRole}
          systemConfig={systemConfig}
        />
      )}
    </>
  );
}

/* ================= Official Website ================= */

function OfficialWebsite({ donations, onNavigate }) {

  const approved = donations.filter(d=>d.status==="approved");

  const total = useMemo(()=>{
    return approved.reduce((s,d)=> s + d.amount,0);
  },[approved]);

  return (
    <div>

      <header className="bg-gray-900 text-white text-center py-20">
        <h1 className="text-4xl font-bold mb-4">วัดไชยามาตย์</h1>
        <p>ยอดเงินรวม {total.toLocaleString()} บาท</p>
        <button
          onClick={()=>onNavigate('system')}
          className="mt-6 bg-orange-600 px-6 py-3 rounded-lg font-bold"
        >
          ร่วมทำบุญ
        </button>
      </header>

      {/* Public Donor List */}
      <section className="py-16 bg-gray-50">
        <div className="max-w-4xl mx-auto bg-white rounded-xl shadow p-6">
          <h2 className="text-2xl font-bold mb-4 text-center">
            รายชื่อผู้ร่วมทำบุญ
          </h2>

          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">ชื่อ</th>
                <th className="p-3 text-right">ยอดเงิน</th>
                <th className="p-3 text-left">วันที่</th>
              </tr>
            </thead>
            <tbody>
              {approved.map(d=>(
                <tr key={d.id} className="border-t">
                  <td className="p-3">{d.name}</td>
                  <td className="p-3 text-right font-bold text-orange-600">
                    {d.amount.toLocaleString()}
                  </td>
                  <td className="p-3">
                    {new Date(d.dateTime).toLocaleDateString('th-TH')}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>

    </div>
  );
}

/* ================= Donation System ================= */

function DonationSystem({ donations, onBack, onAdd, onUpdate, userRole }) {

  const [form,setForm] = useState({ name:'', amount:'' });

  const handleSubmit = (e)=>{
    e.preventDefault();
    onAdd({
      name: form.name,
      amount: Number(form.amount),
      status: userRole==='donor'?'pending':'approved',
      dateTime: new Date().toISOString()
    });
    setForm({name:'',amount:''});
  };

  return (
    <div className="max-w-3xl mx-auto p-6">

      <button onClick={onBack} className="mb-6 text-blue-600">
        ← กลับหน้าแรก
      </button>

      <form onSubmit={handleSubmit} className="bg-white p-6 rounded-xl shadow space-y-4">
        <input
          className="w-full border p-3 rounded"
          placeholder="ชื่อผู้บริจาค"
          value={form.name}
          onChange={e=>setForm({...form,name:e.target.value})}
          required
        />
        <input
          type="number"
          className="w-full border p-3 rounded"
          placeholder="จำนวนเงิน"
          value={form.amount}
          onChange={e=>setForm({...form,amount:e.target.value})}
          required
        />
        <button className="w-full bg-orange-600 text-white py-3 rounded font-bold">
          บันทึก
        </button>
      </form>

      <h3 className="mt-10 text-xl font-bold">รายการทั้งหมด</h3>
      {donations.map(d=>(
        <div key={d.id} className="border-b py-2 flex justify-between">
          <span>{d.name}</span>
          <span>{d.amount.toLocaleString()}</span>
        </div>
      ))}

    </div>
  );
}

createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>
